<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"yoursite.com","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="Scheduler å¤šä»»åŠ¡æ—¶é—´ç®¡ç†å¤§å¸ˆåœ¨ react æå‡º Fiber ä¹‹å‰ï¼Œå¤æ‚è€—æ—¶ä»»åŠ¡ä¼šé˜»å¡é¡µé¢çš„æ¸²æŸ“ï¼Œé™ä½é¡µé¢çš„å“åº”é€Ÿåº¦ï¼Œä¸ºäº†ç¼“è§£è€—æ—¶ä»»åŠ¡ä¸æ¸²æŸ“ç­‰å…¶ä»–è¿›ç¨‹ä¹‹é—´èµ„æºäº‰å¤ºçš„æƒ…å†µï¼Œreact å¢åŠ äº† scheduler è¿™ä¸€æ¨¡å—ï¼Œé€šè¿‡ scheduler æ›´å¥½çš„è°ƒåº¦å¤šä»»åŠ¡ï¼Œæ§åˆ¶ä»»åŠ¡çš„æ‰§è¡Œé¡ºåº scheduler é€šè¿‡åˆ’åˆ†ä»»åŠ¡ä¼˜å…ˆçº§, æ—¶é—´åˆ‡ç‰‡, ä»»åŠ¡ä¸­æ–­ã€ä»»åŠ¡æ¢å¤ç­‰æœºåˆ¶æ¥ä¿è¯é«˜ä¼˜ä»»åŠ¡çš„æ‰§è¡Œï¼Œåªå ç”¨">
<meta property="og:type" content="article">
<meta property="og:title" content="Reactæºç ç»†è¯»-æ·±å…¥äº†è§£scheduler&quot;å¤šä»»åŠ¡æ—¶é—´ç®¡ç†å¤§å¸ˆ&quot;">
<meta property="og:url" content="http://yoursite.com/2021/06/19/React%E6%BA%90%E7%A0%81%E7%BB%86%E8%AF%BB-%E6%B7%B1%E5%85%A5%E4%BA%86%E8%A7%A3scheduler-%E5%A4%9A%E4%BB%BB%E5%8A%A1%E6%97%B6%E9%97%B4%E7%AE%A1%E7%90%86%E5%A4%A7%E5%B8%88/index.html">
<meta property="og:site_name" content="æŸç§‘å­¦ã®å‰ç«¯æ‚è´§é“º">
<meta property="og:description" content="Scheduler å¤šä»»åŠ¡æ—¶é—´ç®¡ç†å¤§å¸ˆåœ¨ react æå‡º Fiber ä¹‹å‰ï¼Œå¤æ‚è€—æ—¶ä»»åŠ¡ä¼šé˜»å¡é¡µé¢çš„æ¸²æŸ“ï¼Œé™ä½é¡µé¢çš„å“åº”é€Ÿåº¦ï¼Œä¸ºäº†ç¼“è§£è€—æ—¶ä»»åŠ¡ä¸æ¸²æŸ“ç­‰å…¶ä»–è¿›ç¨‹ä¹‹é—´èµ„æºäº‰å¤ºçš„æƒ…å†µï¼Œreact å¢åŠ äº† scheduler è¿™ä¸€æ¨¡å—ï¼Œé€šè¿‡ scheduler æ›´å¥½çš„è°ƒåº¦å¤šä»»åŠ¡ï¼Œæ§åˆ¶ä»»åŠ¡çš„æ‰§è¡Œé¡ºåº scheduler é€šè¿‡åˆ’åˆ†ä»»åŠ¡ä¼˜å…ˆçº§, æ—¶é—´åˆ‡ç‰‡, ä»»åŠ¡ä¸­æ–­ã€ä»»åŠ¡æ¢å¤ç­‰æœºåˆ¶æ¥ä¿è¯é«˜ä¼˜ä»»åŠ¡çš„æ‰§è¡Œï¼Œåªå ç”¨">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/008i3skNgy1groqdmp4p4j312s0t4ad2.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/008i3skNgy1gror2vjud5j30u00z9aiz.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/008i3skNgy1grorehzctkj30zq0l0gq1.jpg">
<meta property="og:image" content="https://inews.gtimg.com/newsapp_bt/0/11865093918/1000">
<meta property="og:image" content="https://img.ninnka.top/1624714200073-react%20to%20scheduler.png">
<meta property="og:image" content="https://img.ninnka.top/1624803961539-wenzhongdaipi.jpg">
<meta property="og:image" content="https://img.ninnka.top/1624778324759-Scheduler_scheduleCallback.png">
<meta property="og:image" content="https://img.ninnka.top/1624953540463-xiaoxijie.jpg">
<meta property="og:image" content="https://img.ninnka.top/1624953504886-bukuishini.jpg">
<meta property="og:image" content="https://img.ninnka.top/1624780291235-pushQueue%28minHeap%29.png">
<meta property="og:image" content="https://p3.pstatp.com/origin/pgc-image/3772c86f9b8a47b0b1844fbafb3ae8ca">
<meta property="og:image" content="https://img.ninnka.top/1624786716030-handleTimeout.png">
<meta property="og:image" content="https://img.ninnka.top/1624786804192-advanceTimers.png">
<meta property="og:image" content="https://img.ninnka.top/1624794783571.png">
<meta property="og:image" content="https://img.ninnka.top/1624795445360.png">
<meta property="og:image" content="https://img.ninnka.top/1624795518834.png">
<meta property="og:image" content="https://img.ninnka.top/1624796966538-performWorkUntilDeadline%20%26%20Messagechannel.png">
<meta property="og:image" content="https://img.ninnka.top/1624803015163-a7s52-ifhqj.png">
<meta property="og:image" content="https://img.ninnka.top/1624801928271-flushWork%20%26%20workLoop.png">
<meta property="og:image" content="https://img.ninnka.top/1624804223052-otmeytc2idaafvqyj9c3dcekdw4.jpg">
<meta property="article:published_time" content="2021-06-19T08:43:43.000Z">
<meta property="article:modified_time" content="2021-06-29T07:59:06.615Z">
<meta property="article:author" content="Ninnka">
<meta property="article:tag" content="React">
<meta property="article:tag" content="JavaScript">
<meta property="article:tag" content="Scheduler">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://tva1.sinaimg.cn/large/008i3skNgy1groqdmp4p4j312s0t4ad2.jpg">

<link rel="canonical" href="http://yoursite.com/2021/06/19/React%E6%BA%90%E7%A0%81%E7%BB%86%E8%AF%BB-%E6%B7%B1%E5%85%A5%E4%BA%86%E8%A7%A3scheduler-%E5%A4%9A%E4%BB%BB%E5%8A%A1%E6%97%B6%E9%97%B4%E7%AE%A1%E7%90%86%E5%A4%A7%E5%B8%88/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>Reactæºç ç»†è¯»-æ·±å…¥äº†è§£scheduler"å¤šä»»åŠ¡æ—¶é—´ç®¡ç†å¤§å¸ˆ" | æŸç§‘å­¦ã®å‰ç«¯æ‚è´§é“º</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="åˆ‡æ¢å¯¼èˆªæ ">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">æŸç§‘å­¦ã®å‰ç«¯æ‚è´§é“º</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>é¦–é¡µ</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>æ ‡ç­¾</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>åˆ†ç±»</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>å½’æ¡£</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/06/19/React%E6%BA%90%E7%A0%81%E7%BB%86%E8%AF%BB-%E6%B7%B1%E5%85%A5%E4%BA%86%E8%A7%A3scheduler-%E5%A4%9A%E4%BB%BB%E5%8A%A1%E6%97%B6%E9%97%B4%E7%AE%A1%E7%90%86%E5%A4%A7%E5%B8%88/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Ninnka">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="æŸç§‘å­¦ã®å‰ç«¯æ‚è´§é“º">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Reactæºç ç»†è¯»-æ·±å…¥äº†è§£scheduler"å¤šä»»åŠ¡æ—¶é—´ç®¡ç†å¤§å¸ˆ"
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>

              <time title="åˆ›å»ºæ—¶é—´ï¼š2021-06-19 16:43:43" itemprop="dateCreated datePublished" datetime="2021-06-19T16:43:43+08:00">2021-06-19</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">æ›´æ–°äº</span>
                <time title="ä¿®æ”¹æ—¶é—´ï¼š2021-06-29 15:59:06" itemprop="dateModified" datetime="2021-06-29T15:59:06+08:00">2021-06-29</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">åˆ†ç±»äº</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Web/" itemprop="url" rel="index"><span itemprop="name">Web</span></a>
                </span>
                  ï¼Œ
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Web/JavaScript/" itemprop="url" rel="index"><span itemprop="name">JavaScript</span></a>
                </span>
                  ï¼Œ
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Web/JavaScript/React/" itemprop="url" rel="index"><span itemprop="name">React</span></a>
                </span>
                  ï¼Œ
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Web/JavaScript/React/Scheduler/" itemprop="url" rel="index"><span itemprop="name">Scheduler</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="Scheduler-å¤šä»»åŠ¡æ—¶é—´ç®¡ç†å¤§å¸ˆ"><a href="#Scheduler-å¤šä»»åŠ¡æ—¶é—´ç®¡ç†å¤§å¸ˆ" class="headerlink" title="Scheduler å¤šä»»åŠ¡æ—¶é—´ç®¡ç†å¤§å¸ˆ"></a>Scheduler å¤šä»»åŠ¡æ—¶é—´ç®¡ç†å¤§å¸ˆ</h1><p>åœ¨ <code>react</code> æå‡º <code>Fiber</code> ä¹‹å‰ï¼Œå¤æ‚è€—æ—¶ä»»åŠ¡ä¼šé˜»å¡é¡µé¢çš„æ¸²æŸ“ï¼Œé™ä½é¡µé¢çš„å“åº”é€Ÿåº¦ï¼Œä¸ºäº†ç¼“è§£è€—æ—¶ä»»åŠ¡ä¸æ¸²æŸ“ç­‰å…¶ä»–è¿›ç¨‹ä¹‹é—´èµ„æºäº‰å¤ºçš„æƒ…å†µï¼Œ<code>react</code> å¢åŠ äº† <code>scheduler</code> è¿™ä¸€æ¨¡å—ï¼Œé€šè¿‡ <code>scheduler</code> æ›´å¥½çš„è°ƒåº¦å¤šä»»åŠ¡ï¼Œæ§åˆ¶ä»»åŠ¡çš„æ‰§è¡Œé¡ºåº</p>
<p><code>scheduler</code> é€šè¿‡åˆ’åˆ†ä»»åŠ¡ä¼˜å…ˆçº§, æ—¶é—´åˆ‡ç‰‡, ä»»åŠ¡ä¸­æ–­ã€ä»»åŠ¡æ¢å¤ç­‰æœºåˆ¶æ¥ä¿è¯é«˜ä¼˜ä»»åŠ¡çš„æ‰§è¡Œï¼Œåªå ç”¨æ¯ä¸€å¸§ä¸­å°½å¯èƒ½çŸ­çš„æ—¶é—´ç”¨äºå¤„ç†ä»»åŠ¡ï¼ŒæŠŠä¸»è¦èµ„æºåœ¨æœ‰å¿…è¦çš„æƒ…å†µä¸‹äº¤è¿˜ç»™å…¶ä»–çº¿ç¨‹ï¼Œä»¥æ­¤æé«˜é¡µé¢å“åº”é€Ÿåº¦ï¼Œæå‡ç”¨æˆ·ä½“éªŒ</p>
<p>èƒ½åšåˆ°çš„è¿™äº›ä¸å¾—ä¸è¯´æ˜¯â€œå¤šä»»åŠ¡æ—¶é—´ç®¡ç†å¤§å¸ˆâ€äº†ğŸ˜</p>
<p><strong>æ­¤æ–‡åŸºäº <code>react v17.0.2</code> <code>scheduler v0.20.0</code> åˆ†æï¼Œ<a target="_blank" rel="noopener" href="https://github.com/facebook/react">ä»“åº“ä¼ é€é—¨</a></strong></p>
<h1 id="React-amp-Scheduler-ç¼ ç¼ ç»µç»µ"><a href="#React-amp-Scheduler-ç¼ ç¼ ç»µç»µ" class="headerlink" title="React &amp; Scheduler ç¼ ç¼ ç»µç»µ"></a>React &amp; Scheduler ç¼ ç¼ ç»µç»µ</h1><p>å‰é¢æåˆ° <code>scheduler</code> å¯ä»¥å¸®åŠ© <code>react</code> æ›´å¥½çš„å»è°ƒåº¦å’Œæ§åˆ¶å¤šä»»åŠ¡çš„æ‰§è¡Œï¼Œé‚£ä¹ˆ <code>react</code> æ˜¯æ€ä¹ˆæŠŠäº¤ç»™ <code>scheduler</code> è°ƒåº¦å’Œæ§åˆ¶æ‰§è¡Œçš„å‘¢ï¼Ÿ</p>
<p><strong>è¿™é‡Œä¸å¯¹reactåˆ°schedulerçš„æµç¨‹åšæ·±å…¥è§£è¯»ï¼Œä»…ç”¨äºäº¤ä»£ä»reactåˆ°schedulerçš„æµç¨‹è¿‡æ¸¡</strong></p>
<p>è¯ä¸å¤šè¯´ï¼Œè€è§„çŸ©ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸ªç®€å•çš„ demo</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> React <span class="keyword">from</span> <span class="string">&quot;react&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">PureComponent</span> </span>&#123;</span><br><span class="line">  state = &#123;</span><br><span class="line">    val: <span class="number">1</span></span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">	onClickBtn = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.setState(&#123; <span class="attr">val</span>: <span class="number">2</span> &#125;);</span><br><span class="line">    <span class="built_in">this</span>.setState(&#123; <span class="attr">val</span>: <span class="number">3</span> &#125;);</span><br><span class="line">    <span class="built_in">this</span>.setState(&#123; <span class="attr">val</span>: <span class="number">4</span> &#125;);</span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">this</span>.setState(&#123; <span class="attr">val</span>: <span class="number">5</span> &#125;);</span><br><span class="line">      <span class="built_in">this</span>.setState(&#123; <span class="attr">val</span>: <span class="number">6</span> &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; val &#125; = <span class="built_in">this</span>.state;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;p&gt;</span><br><span class="line">        &lt;button onClick=&#123;<span class="built_in">this</span>.onClickBtn&#125;&gt;click&lt;/button&gt;</span><br><span class="line">        &#123;val&#125;</span><br><span class="line">      &lt;/p&gt;</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">App</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;A /&gt;</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ¡ˆä¾‹çš„è§†å›¾å¾ˆç®€å•ï¼Œå°±åªæœ‰ä¸€ä¸ªæŒ‰é’®å’Œä¸€ä¸ªå€¼ï¼Œå½“ç‚¹å‡» click æ—¶ï¼Œä¼šè§¦å‘ <code>setState</code>ï¼Œè§†å›¾çš„å€¼ä¹Ÿä¼šå‘ç”Ÿå˜åŒ–</p>
<a id="more"></a>

<p><img src="https://tva1.sinaimg.cn/large/008i3skNgy1groqdmp4p4j312s0t4ad2.jpg"></p>
<p>äº†è§£ <code>react setState</code>  æœºåˆ¶çš„æœ‹å‹éƒ½çŸ¥é“ï¼Œ<code>react18</code> ä¹‹å‰çš„æ‰¹é‡æ›´æ–°æ˜¯åŒºåˆ†åœºæ™¯çš„ï¼Œè¿™é‡Œçš„å‰ä¸‰ä¸ª <code>setState</code> å› ä¸ºå¤„äºäº‹ä»¶å›è°ƒå‡½æ•°çš„åŒæ­¥è°ƒç”¨ä¸­ï¼Œæ‰€ä»¥åœ¨è§¦å‘ <code>setState</code> æ—¶ä¼šè¿›å…¥ <code>enqueueUpdate</code> å‡½æ•°</p>
<p><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gror2vjud5j30u00z9aiz.jpg"></p>
<h2 id="enqueueUpdate-å‡½æ•°"><a href="#enqueueUpdate-å‡½æ•°" class="headerlink" title="enqueueUpdate å‡½æ•°"></a>enqueueUpdate å‡½æ•°</h2><p>ç®€åŒ–ä¸€ä¸‹ <code>enqueueUpdate</code> å‡½æ•°åå¯ä»¥çŸ¥é“ï¼Œå®ƒæœ¬è´¨å°±åšäº†ä¸€ä»¶ç®€å•çš„äº‹ï¼šæŠŠå½“å‰åˆ›å»ºçš„æ›´æ–°å¯¹è±¡ <code>Update</code> å­˜å…¥å½“å‰ <code>Fiber</code> å®ä¾‹çš„ <code>updateQueue.shared</code> é˜Ÿåˆ—ä¸­ï¼Œ<code>updateQueue.shared</code> å·²é“¾è¡¨ç»“æ„å­˜åœ¨ï¼Œé€šè¿‡ <code>next</code> æŒ‡é’ˆé“¾æ¥ä¸‹ä¸€ä¸ª <code>Update</code> å¯¹è±¡</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">enqueueUpdate</span>&lt;<span class="title">State</span>&gt;(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  fiber: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">  update: Update&lt;State&gt;,</span></span></span><br><span class="line"><span class="function"><span class="params">  lane: Lane,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> updateQueue = fiber.updateQueue;</span><br><span class="line">  <span class="keyword">const</span> sharedQueue: SharedQueue&lt;State&gt; = (updateQueue: any).shared;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (isInterleavedUpdate(fiber, lane)) &#123;</span><br><span class="line">    <span class="comment">// ....</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> pending = sharedQueue.pending;</span><br><span class="line">    <span class="keyword">if</span> (pending === <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="comment">// This is the first update. Create a circular list.</span></span><br><span class="line">      update.next = update;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      update.next = pending.next;</span><br><span class="line">      pending.next = update;</span><br><span class="line">    &#125;</span><br><span class="line">    sharedQueue.pending = update;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>enqueueUpdate</code> æ“ä½œäº†ä¸€ä¸ªå¾ˆå…³é”®çš„å¯¹è±¡-<code>Update</code>ï¼Œè¿™ä¸ªåœ¨åç»­è·Ÿ <code>Scheduler</code> çš„äº¤äº’ä¸­æœ‰å¾ˆæ·±çš„å…³è”ï¼Œæˆ‘ä»¬å…ˆçœ‹çœ‹å®ƒå…·ä½“æ˜¯ä»€ä¹ˆ</p>
<h2 id="Update-å¯¹è±¡"><a href="#Update-å¯¹è±¡" class="headerlink" title="Update å¯¹è±¡"></a>Update å¯¹è±¡</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// @flow</span></span><br><span class="line"><span class="keyword">export</span> type Update&lt;State&gt; = &#123;|</span><br><span class="line">	<span class="comment">// eventTime æ˜¯ä¸´æ—¶å±æ€§ï¼Œåç»­ä¼šé€šè¿‡åœ¨ root èŠ‚ç‚¹å­˜å‚¨ä¸€ä¸ª transition æ˜ å°„åˆ° event-time çš„ map æ¥æ›¿ä»–è¿™ä¸ªå±æ€§</span></span><br><span class="line">  eventTime: number,</span><br><span class="line">  lane: Lane,</span><br><span class="line"></span><br><span class="line">  tag: <span class="number">0</span> | <span class="number">1</span> | <span class="number">2</span> | <span class="number">3</span>,</span><br><span class="line">  payload: any,</span><br><span class="line">  callback: (<span class="function">() =&gt;</span> mixed) | <span class="literal">null</span>,</span><br><span class="line"></span><br><span class="line">  next: Update&lt;State&gt; | <span class="literal">null</span>,</span><br><span class="line">|&#125;;</span><br></pre></td></tr></table></figure>

<p>ä» <code>Update</code> çš„æ•°æ®ç»“æ„å¯ä»¥ç®€å•äº†è§£åˆ°ï¼Œ<code>Update</code> æ˜¯ç”¨æ¥æè¿°å½“å‰çš„å¯¹è±¡æ“ä½œçš„ä¸€äº›åŸºæœ¬ä¿¡æ¯ï¼šæ—¶é—´ï¼ˆeventTimeï¼‰ã€ä¼˜å…ˆçº§ï¼ˆlaneï¼‰ã€å›è°ƒå‡½æ•°ï¼ˆcallbackï¼‰ã€ä¸‹ä¸€ä¸ªæ›´æ–°å¯¹è±¡ï¼ˆnextï¼‰ç­‰</p>
<p><img src="https://tva1.sinaimg.cn/large/008i3skNgy1grorehzctkj30zq0l0gq1.jpg"></p>
<p>éœ€è¦æ³¨æ„è¿™é‡Œçš„ç”¨æ¥è¡¨ç¤ºä¼˜å…ˆçº§çš„å±æ€§ <code>lane</code></p>
<h2 id="Lane-å¤šè½¦é“ä¼˜å…ˆçº§æ¨¡å‹"><a href="#Lane-å¤šè½¦é“ä¼˜å…ˆçº§æ¨¡å‹" class="headerlink" title="Lane å¤šè½¦é“ä¼˜å…ˆçº§æ¨¡å‹"></a>Lane å¤šè½¦é“ä¼˜å…ˆçº§æ¨¡å‹</h2><p><code>Lane</code> æ¨¡å‹æ˜¯ <code>react</code> ä¸ºäº†è§£å†³ <code>ExpirationTime</code> æ¨¡å‹å¯¼è‡´çš„ä½ä¼˜å…ˆçº§ä»»åŠ¡ <code>é•¿æ—¶é—´ç­‰å¾…/é¥¿æ­»</code> çš„é—®é¢˜</p>
<p>ç›®å‰ <code>react</code> ä¸­å…±æœ‰ 31 ç§ä¸åŒçš„ <code>lane</code> å€¼ï¼Œå…¶ä¸­åŒºåˆ†äº†ä¸åŒçš„ <code>lane è½¦é“</code> ä¸ <code>lanes è½¦é“ç»„</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> type Lanes = number;</span><br><span class="line"><span class="keyword">export</span> type Lane = number;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> TotalLanes = <span class="number">31</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> NoLanes: Lanes = <span class="comment">/*                        */</span> <span class="number">0b0000000000000000000000000000000</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> NoLane: Lane = <span class="comment">/*                          */</span> <span class="number">0b0000000000000000000000000000000</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> SyncLane: Lane = <span class="comment">/*                        */</span> <span class="number">0b0000000000000000000000000000001</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> InputContinuousHydrationLane: Lane = <span class="comment">/*    */</span> <span class="number">0b0000000000000000000000000000010</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> InputContinuousLane: Lanes = <span class="comment">/*            */</span> <span class="number">0b0000000000000000000000000000100</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> DefaultHydrationLane: Lane = <span class="comment">/*            */</span> <span class="number">0b0000000000000000000000000001000</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> DefaultLane: Lanes = <span class="comment">/*                    */</span> <span class="number">0b0000000000000000000000000010000</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> TransitionHydrationLane: Lane = <span class="comment">/*                */</span> <span class="number">0b0000000000000000000000000100000</span>;</span><br><span class="line"><span class="keyword">const</span> TransitionLanes: Lanes = <span class="comment">/*                       */</span> <span class="number">0b0000000001111111111111111000000</span>;</span><br><span class="line"><span class="keyword">const</span> TransitionLane1: Lane = <span class="comment">/*                        */</span> <span class="number">0b0000000000000000000000001000000</span>;</span><br><span class="line"><span class="keyword">const</span> TransitionLane2: Lane = <span class="comment">/*                        */</span> <span class="number">0b0000000000000000000000010000000</span>;</span><br><span class="line"><span class="keyword">const</span> TransitionLane3: Lane = <span class="comment">/*                        */</span> <span class="number">0b0000000000000000000000100000000</span>;</span><br><span class="line"><span class="keyword">const</span> TransitionLane4: Lane = <span class="comment">/*                        */</span> <span class="number">0b0000000000000000000001000000000</span>;</span><br><span class="line"><span class="keyword">const</span> TransitionLane5: Lane = <span class="comment">/*                        */</span> <span class="number">0b0000000000000000000010000000000</span>;</span><br><span class="line"><span class="keyword">const</span> TransitionLane6: Lane = <span class="comment">/*                        */</span> <span class="number">0b0000000000000000000100000000000</span>;</span><br><span class="line"><span class="keyword">const</span> TransitionLane7: Lane = <span class="comment">/*                        */</span> <span class="number">0b0000000000000000001000000000000</span>;</span><br><span class="line"><span class="keyword">const</span> TransitionLane8: Lane = <span class="comment">/*                        */</span> <span class="number">0b0000000000000000010000000000000</span>;</span><br><span class="line"><span class="keyword">const</span> TransitionLane9: Lane = <span class="comment">/*                        */</span> <span class="number">0b0000000000000000100000000000000</span>;</span><br><span class="line"><span class="keyword">const</span> TransitionLane10: Lane = <span class="comment">/*                       */</span> <span class="number">0b0000000000000001000000000000000</span>;</span><br><span class="line"><span class="keyword">const</span> TransitionLane11: Lane = <span class="comment">/*                       */</span> <span class="number">0b0000000000000010000000000000000</span>;</span><br><span class="line"><span class="keyword">const</span> TransitionLane12: Lane = <span class="comment">/*                       */</span> <span class="number">0b0000000000000100000000000000000</span>;</span><br><span class="line"><span class="keyword">const</span> TransitionLane13: Lane = <span class="comment">/*                       */</span> <span class="number">0b0000000000001000000000000000000</span>;</span><br><span class="line"><span class="keyword">const</span> TransitionLane14: Lane = <span class="comment">/*                       */</span> <span class="number">0b0000000000010000000000000000000</span>;</span><br><span class="line"><span class="keyword">const</span> TransitionLane15: Lane = <span class="comment">/*                       */</span> <span class="number">0b0000000000100000000000000000000</span>;</span><br><span class="line"><span class="keyword">const</span> TransitionLane16: Lane = <span class="comment">/*                       */</span> <span class="number">0b0000000001000000000000000000000</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> RetryLanes: Lanes = <span class="comment">/*                            */</span> <span class="number">0b0000111110000000000000000000000</span>;</span><br><span class="line"><span class="keyword">const</span> RetryLane1: Lane = <span class="comment">/*                             */</span> <span class="number">0b0000000010000000000000000000000</span>;</span><br><span class="line"><span class="keyword">const</span> RetryLane2: Lane = <span class="comment">/*                             */</span> <span class="number">0b0000000100000000000000000000000</span>;</span><br><span class="line"><span class="keyword">const</span> RetryLane3: Lane = <span class="comment">/*                             */</span> <span class="number">0b0000001000000000000000000000000</span>;</span><br><span class="line"><span class="keyword">const</span> RetryLane4: Lane = <span class="comment">/*                             */</span> <span class="number">0b0000010000000000000000000000000</span>;</span><br><span class="line"><span class="keyword">const</span> RetryLane5: Lane = <span class="comment">/*                             */</span> <span class="number">0b0000100000000000000000000000000</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> SomeRetryLane: Lane = RetryLane1;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> SelectiveHydrationLane: Lane = <span class="comment">/*          */</span> <span class="number">0b0001000000000000000000000000000</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> NonIdleLanes = <span class="comment">/*                                 */</span> <span class="number">0b0001111111111111111111111111111</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> IdleHydrationLane: Lane = <span class="comment">/*               */</span> <span class="number">0b0010000000000000000000000000000</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> IdleLane: Lanes = <span class="comment">/*                       */</span> <span class="number">0b0100000000000000000000000000000</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> OffscreenLane: Lane = <span class="comment">/*                   */</span> <span class="number">0b1000000000000000000000000000000</span>;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œå…ˆä¸å±•å¼€è¯´æ˜ï¼Œåç»­ä¼šå¦å¼€ä¸€ç¯‡æ·±å…¥æ¢è®¨</p>
<p>æˆ‘ä»¬æ¥ç€ <code>enqueueUpdate</code> åˆ†æï¼Œåœ¨æ‰§è¡Œå®Œ <code>enqueueUpdate</code> åï¼Œç´§æ¥ç€åˆ°äº† <code>scheduleUpdateOnFiber</code>ï¼Œè¿™ä¸ªæ˜¯ <code>react</code> ä¸ <code>scheduler</code> æ¥è§¦çš„èµ·ç‚¹</p>
<h2 id="scheduleUpdateOnFiber-å‡½æ•°"><a href="#scheduleUpdateOnFiber-å‡½æ•°" class="headerlink" title="scheduleUpdateOnFiber å‡½æ•°"></a>scheduleUpdateOnFiber å‡½æ•°</h2><p>è€è§„åˆ™ï¼Œå…ˆæ¥åˆ†æç®€åŒ–åçš„ä¸»è¦é€»è¾‘</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">scheduleUpdateOnFiber</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  fiber: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">  lane: Lane,</span></span></span><br><span class="line"><span class="function"><span class="params">  eventTime: number,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// ç»™æ ¹èŠ‚ç‚¹æ ‡è®°æœ‰æ›´æ–°</span></span><br><span class="line">  markRootUpdated(root, lane, eventTime);</span><br><span class="line">  <span class="comment">// åœ¨å½“å‰ Fiber å®ä¾‹çš„ lanes å’Œæ‰€æœ‰çˆ¶èŠ‚ç‚¹çš„ childLanes ä¸­æ·»åŠ å½“å‰ Update.lane</span></span><br><span class="line">	<span class="keyword">const</span> root = markUpdateLaneFromFiberToRoot(fiber, lane);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è·å–å½“å‰ä»»åŠ¡çš„ react ä¼˜å…ˆçº§</span></span><br><span class="line">  <span class="keyword">const</span> priorityLevel = getCurrentPriorityLevel();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (lane === SyncLane) &#123;</span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">      <span class="comment">// ... è¾¹ç¼˜åœºæ™¯å¤„ç†ï¼ˆè¿™é‡Œä¸ç®¡ï¼‰</span></span><br><span class="line">    ) &#123;</span><br><span class="line">      <span class="comment">// ... è¾¹ç¼˜åœºæ™¯å¤„ç†ï¼ˆè¿™é‡Œä¸ç®¡ï¼‰</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      ensureRootIsScheduled(root, eventTime);</span><br><span class="line">      schedulePendingInteractions(root, lane);</span><br><span class="line">      <span class="comment">// ... è¾¹ç¼˜åœºæ™¯å¤„ç†ï¼ˆè¿™é‡Œä¸ç®¡ï¼‰</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="comment">// è¿™ä¸€æ®µåˆ¤æ–­å¾ˆé•¿ï¼Œä¸»è¦æ˜¯é’ˆå¯¹ `ç¦»æ•£äº‹ä»¶` å¯¼è‡´çš„æ›´æ–°å’Œé«˜ä¼˜å…ˆçº§ä»»åŠ¡åšäº†ç‰¹æ®Šå¤„ç†</span></span><br><span class="line">		<span class="comment">// æ¯”å¦‚è¯´ç”¨æˆ·è¾“å…¥æˆ–è€…ç”¨æˆ·ç‚¹å‡»ç­‰äº¤äº’äº‹ä»¶ï¼Œå¦‚æœè¿™äº›äº‹ä»¶ç”Ÿæˆæ–°çš„ update</span></span><br><span class="line">		<span class="comment">// é‚£ä¹ˆéœ€è¦æŠŠå½“å‰æ ¹èŠ‚ä¿å­˜åˆ° rootsWithPendingDiscreteUpdatesï¼ˆSetç»“æ„ï¼‰ä¸­</span></span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">      (executionContext &amp; DiscreteEventContext) !== NoContext &amp;&amp;</span><br><span class="line">      (priorityLevel === UserBlockingSchedulerPriority ||</span><br><span class="line">        priorityLevel === ImmediateSchedulerPriority)</span><br><span class="line">    ) &#123;</span><br><span class="line">      <span class="keyword">if</span> (rootsWithPendingDiscreteUpdates === <span class="literal">null</span>) &#123;</span><br><span class="line">        rootsWithPendingDiscreteUpdates = <span class="keyword">new</span> <span class="built_in">Set</span>([root]);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        rootsWithPendingDiscreteUpdates.add(root);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ensureRootIsScheduled(root, eventTime);</span><br><span class="line">    schedulePendingInteractions(root, lane);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ä¿å­˜æœ€è¿‘æ›´æ–°çš„èŠ‚ç‚¹</span></span><br><span class="line">  mostRecentlyUpdatedRoot = root;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä»ç®€åŒ–åçš„ä»£ç ä¸éš¾çœ‹å‡ºï¼Œ<code>scheduleUpdateOnFiber</code> ä¸»è¦åšäº†è¿™å‡ ä»¶äº‹</p>
<ol>
<li>åŒºåˆ† <code>SyncLane</code> ç­‰çº§å’Œå…¶ä»– <code>Lane</code> ç­‰çº§åšä¸åŒçš„å¤„ç†</li>
<li>æ— è®ºæ˜¯å“ªç§ <code>Lane</code>ï¼Œæœ€åéƒ½æ‰§è¡Œ <code>ensureRootIsScheduled</code> å‡½æ•°</li>
</ol>
<p>è€Œ <code>ensureRootIsScheduled</code> å°±æ˜¯è¿›å…¥è°ƒåº¦é¢†åŸŸçš„æœ€åä¸€æ­¥</p>
<h2 id="ensureRootIsScheduled-å‡½æ•°"><a href="#ensureRootIsScheduled-å‡½æ•°" class="headerlink" title="ensureRootIsScheduled å‡½æ•°"></a>ensureRootIsScheduled å‡½æ•°</h2><p><code>ensureRootIsScheduled</code> å‡½æ•°æ˜¯ <code>react</code> æŠŠä»»åŠ¡äº¤ç”± <code>scheduler</code> è°ƒåº¦çš„æœ€åä¸€æ­¥</p>
<p><code>ensureRootIsScheduled</code> åŒæ ·æœ‰å¤„ç†åˆ†æ”¯åœºæ™¯å’Œè¾¹ç¼˜åœºæ™¯ï¼Œè¿˜æœ‰æœ€é«˜ <code>Lane</code> ä¼˜å…ˆçº§çš„è·å–å¤„ç†ï¼Œè¿™é‡Œæš‚ä¸”ä¸æ·±å…¥</p>
<p>è™½ç„¶è¿™é‡Œçš„ä»£ç å¾ˆé•¿ï¼Œå†…éƒ¨è°ƒç”¨çš„å‡½æ•°åˆå¤šè¿˜ä¸å¥½ç†è§£ï¼Œçœ‹çš„è®©äººä¸€è„¸æ‡µé€¼ğŸ˜³</p>
<p>ä¸ºäº†é¿å…æ€è·¯è¢«å¸å¼•å¼€ï¼Œè¿™é‡Œæˆ‘ä»¬åªéœ€è®°ä½ä¸¤ä¸ªåœ°æ–¹ <code>è°ƒåº¦å…¥å£1</code> å’Œ <code>è°ƒåº¦å…¥å£3</code>ï¼Œå…¶ä»–æœ‰å¿…è¦çš„éƒ¨åˆ†åªä¼šç¨å¾®æä¸€ä¸‹</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ensureRootIsScheduled</span>(<span class="params">root: FiberRoot, currentTime: number</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">	<span class="comment">// è·å–æœ€é«˜ lane ç­‰çº§çš„æ–°ä»»åŠ¡çš„ lane å€¼</span></span><br><span class="line">  <span class="comment">// åŒæ—¶è®¾ç½®å…¨å±€å˜é‡ return_highestLanePriority</span></span><br><span class="line">	<span class="comment">// return_highestLanePriority å¯¹åº”çš„æ˜¯ æœ€é«˜ lane ç­‰çº§çš„ä¼˜å…ˆçº§</span></span><br><span class="line">	<span class="comment">// return_highestLanePriority å¯ä»¥é€šè¿‡ returnNextLanesPriority å‡½æ•°è¿”å›</span></span><br><span class="line">  <span class="keyword">const</span> nextLanes = getNextLanes(</span><br><span class="line">    root,</span><br><span class="line">    root === workInProgressRoot ? workInProgressRootRenderLanes : NoLanes,</span><br><span class="line">  );</span><br><span class="line">	<span class="comment">// newCallbackPriority å®é™…å°±æ˜¯ return_highestLanePriority</span></span><br><span class="line">	<span class="comment">// ä¹Ÿå°±æ˜¯ nextLanes lane ç­‰çº§å¯¹åº”çš„ lane ä¼˜å…ˆçº§</span></span><br><span class="line">  <span class="keyword">const</span> newCallbackPriority = returnNextLanesPriority();</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="comment">// å¼€å¯ä¸€ä¸ªæ–°çš„è°ƒåº¦</span></span><br><span class="line">  <span class="keyword">let</span> newCallbackNode;</span><br><span class="line">  <span class="keyword">if</span> (newCallbackPriority === SyncLanePriority) &#123;</span><br><span class="line">		<span class="comment">// è°ƒåº¦å…¥å£1</span></span><br><span class="line">    newCallbackNode = scheduleSyncCallback(</span><br><span class="line">      performSyncWorkOnRoot.bind(<span class="literal">null</span>, root),</span><br><span class="line">    );</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (newCallbackPriority === SyncBatchedLanePriority) &#123;</span><br><span class="line">		<span class="comment">// è°ƒåº¦å…¥å£2</span></span><br><span class="line">    <span class="comment">// ... è¾¹ç¼˜åœºæ™¯ï¼ˆè¿™é‡Œä¸ç®¡ï¼‰</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> schedulerPriorityLevel = lanePriorityToSchedulerPriority(</span><br><span class="line">      newCallbackPriority,</span><br><span class="line">    );</span><br><span class="line">		<span class="comment">// è°ƒåº¦å…¥å£ 3</span></span><br><span class="line">    newCallbackNode = scheduleCallback(</span><br><span class="line">      schedulerPriorityLevel,</span><br><span class="line">      performConcurrentWorkOnRoot.bind(<span class="literal">null</span>, root),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  root.callbackPriority = newCallbackPriority;</span><br><span class="line">  root.callbackNode = newCallbackNode;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬ä¸‹æ¥çœ‹çœ‹ <code>ensureRootIsScheduled</code> åšäº†å“ªäº›äº‹</p>
<ol>
<li><code>nextLanes</code> è·å–æœ€é«˜ lane ç­‰çº§æ–°ä»»åŠ¡çš„ lanes å€¼</li>
<li><code>newCallbackPriority</code> è·å–æœ€é«˜ lane ç­‰çº§çš„ä¼˜å…ˆçº§</li>
<li>æ ¹æ® <code>newCallbackPriority</code> è¿›å…¥ä¸åŒçš„è°ƒåº¦å…¥å£ï¼Œæ¯”å¦‚ <code>è°ƒåº¦å…¥å£1</code> å’Œ <code>è°ƒåº¦å…¥å£3</code></li>
</ol>
<h3 id="lanePriorityToSchedulerPriority"><a href="#lanePriorityToSchedulerPriority" class="headerlink" title="lanePriorityToSchedulerPriority"></a>lanePriorityToSchedulerPriority</h3><p>è¿™é‡Œéœ€è¦é¢å¤–æä¸€ä¸‹ <code>lanePriorityToSchedulerPriority</code>ï¼Œè¿™é‡Œçš„å‡½æ•°åå®é™…ä¸Šä¸åšçš„äº‹æƒ…æœ‰äº›å‡ºå…¥ï¼Œè¿™é‡Œçš„ <code>Scheduler Priority</code> å®é™…æ˜¯æŒ‡çš„ <code>react</code> å†…éƒ¨çš„ <code>React Scheduler Priority</code>ï¼Œä¸æ˜¯ <code>Schduler Priority</code></p>
<p>ä¸æ˜¯ä½ çš„é”™è§‰ï¼Œè¿™é‡Œçœ‹èµ·æ¥ç¡®å®å¾ˆç»•ğŸ˜­</p>
<p>è¯´å›æ­£é¢˜ï¼Œè¿™ä¸ªå‡½æ•°æœ¬è´¨å°±æ˜¯æŠŠ <code>Lane</code> æ¨¡å‹çš„ä¼˜å…ˆçº§æœºåˆ¶è½¬åŒ–æˆ <code>React Schduler</code> çš„ä¼˜å…ˆçº§æœºåˆ¶</p>
<p>ä»£ç æœ¬ä½“å°±æ˜¯å¦‚æ­¤ç®€å•ï¼Œé€šè¿‡ä¸€é•¿ä¸² <code>switch case</code>ï¼ŒæŠŠ <code>Lane</code> ä¼˜å…ˆçº§è½¬ä¸º <code>React Scheduler</code> ä¼˜å…ˆçº§</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">lanePriorityToSchedulerPriority</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  lanePriority: LanePriority,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">ReactPriorityLevel</span> </span>&#123;</span><br><span class="line">  <span class="keyword">switch</span> (lanePriority) &#123;</span><br><span class="line">    <span class="keyword">case</span> SyncLanePriority:</span><br><span class="line">    <span class="keyword">case</span> SyncBatchedLanePriority:</span><br><span class="line">      <span class="keyword">return</span> ImmediateSchedulerPriority;</span><br><span class="line">    <span class="keyword">case</span> InputDiscreteHydrationLanePriority:</span><br><span class="line">    <span class="keyword">case</span> InputDiscreteLanePriority:</span><br><span class="line">    <span class="keyword">case</span> InputContinuousHydrationLanePriority:</span><br><span class="line">    <span class="keyword">case</span> InputContinuousLanePriority:</span><br><span class="line">      <span class="keyword">return</span> UserBlockingSchedulerPriority;</span><br><span class="line">    <span class="keyword">case</span> DefaultHydrationLanePriority:</span><br><span class="line">    <span class="keyword">case</span> DefaultLanePriority:</span><br><span class="line">    <span class="keyword">case</span> TransitionHydrationPriority:</span><br><span class="line">    <span class="keyword">case</span> TransitionPriority:</span><br><span class="line">    <span class="keyword">case</span> SelectiveHydrationLanePriority:</span><br><span class="line">    <span class="keyword">case</span> RetryLanePriority:</span><br><span class="line">      <span class="keyword">return</span> NormalSchedulerPriority;</span><br><span class="line">    <span class="keyword">case</span> IdleHydrationLanePriority:</span><br><span class="line">    <span class="keyword">case</span> IdleLanePriority:</span><br><span class="line">    <span class="keyword">case</span> OffscreenLanePriority:</span><br><span class="line">      <span class="keyword">return</span> IdleSchedulerPriority;</span><br><span class="line">    <span class="keyword">case</span> NoLanePriority:</span><br><span class="line">      <span class="keyword">return</span> NoSchedulerPriority;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      invariant(</span><br><span class="line">        <span class="literal">false</span>,</span><br><span class="line">        <span class="string">&#x27;Invalid update priority: %s. This is a bug in React.&#x27;</span>,</span><br><span class="line">        lanePriority,</span><br><span class="line">      );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åˆšåˆšæåˆ°äº† <code>React Scheduler Priority</code> å’Œ <code>Schduler Priority</code>ï¼Œè¿™é‡Œå¯ä»¥ä¸ç”¨çº ç»“ï¼Œåœ¨ <code>react</code> ä¸­ä¼šå¯¹ä»–ä»¬çš„å…³ç³»åšä¸€ä¸ªæ˜ å°„ï¼Œæ¥ç€å¾€ä¸‹çœ‹ï¼Œåé¢ä¼šæåˆ°</p>
<h3 id="scheduleSyncCallback-amp-scheduleCallback-è°ƒåº¦å…¥å£"><a href="#scheduleSyncCallback-amp-scheduleCallback-è°ƒåº¦å…¥å£" class="headerlink" title="scheduleSyncCallback &amp; scheduleCallback è°ƒåº¦å…¥å£"></a>scheduleSyncCallback &amp; scheduleCallback è°ƒåº¦å…¥å£</h3><p>è¿™ä¸¤ä¸ªè°ƒåº¦å…¥å£çš„æœ¬è´¨å…¶å®éƒ½æ˜¯è°ƒç”¨ <code>Scheduler_scheduleCallback</code> å‡½æ•°ï¼Œå¯åŠ¨è°ƒåº¦æµç¨‹</p>
<p>å›æƒ³ä¸Šä¸€å°èŠ‚ä¸­æåˆ°çš„ <code>React Scheduler Priority</code> å’Œ <code>Schduler Priority</code>ï¼Œåœ¨çœŸæ­£è¿›å…¥ <code>Scheduler</code> æµç¨‹ä¹‹å‰ï¼Œä¼šé€šè¿‡ <code>reactPriorityToSchedulerPriority</code> å‡½æ•°åšè½¬æ¢</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">scheduleCallback</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  reactPriorityLevel: ReactPriorityLevel,</span></span></span><br><span class="line"><span class="function"><span class="params">  callback: SchedulerCallback,</span></span></span><br><span class="line"><span class="function"><span class="params">  options: SchedulerCallbackOptions | <span class="keyword">void</span> | <span class="literal">null</span>,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// `React Scheduler Priority` è½¬æ¢ä¸º `Schduler Priority`</span></span><br><span class="line">  <span class="keyword">const</span> priorityLevel = reactPriorityToSchedulerPriority(reactPriorityLevel);</span><br><span class="line">	<span class="comment">// çœŸæ­£çš„è°ƒåº¦å¼€å§‹</span></span><br><span class="line">  <span class="keyword">return</span> Scheduler_scheduleCallback(priorityLevel, callback, options);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å³ç„¶æœ‰ <code>scheduleCallback</code>ï¼Œé‚£ä¹ˆä¸ºä»€ä¹ˆè¿˜éœ€è¦ <code>scheduleSyncCallback</code>ï¼Ÿ</p>
<div align="center">
<img width=200 src="https://inews.gtimg.com/newsapp_bt/0/11865093918/1000"/>
</div>

<p><code>scheduleCallback</code> å’Œ <code>scheduleSyncCallback</code> ä¸æ˜¯æ—¢ç”Ÿç‘œä½•ç”Ÿäº®çš„å…³ç³»ï¼Œå®ƒä»¬æœ‰ä¸ä¸€æ ·çš„æµç¨‹</p>
<p>ä¸åŒçš„ç‚¹åœ¨äºï¼Œ<code>scheduleCallback</code> éœ€è¦å°† <code>React Scheduler</code> ä¼˜å…ˆçº§è½¬ä¸º <code>Scheduler</code> ä¼˜å…ˆçº§</p>
<p>æ­¤å¤–ï¼Œ<code>scheduleSyncCallback</code> ä¼šæŠŠ <code>callback</code> æ¨å…¥ <code>syncQueue</code> é˜Ÿåˆ—ä¿å­˜èµ·æ¥ï¼Œåœ¨åç»­æ‰§è¡Œ <code>flushSyncCallbackQueue</code> æ—¶ä½¿ç”¨ï¼Œè¿™é‡Œçš„ <code>syncQueue</code> æ˜¯ <code>react</code> å†…éƒ¨çš„ä»»åŠ¡é˜Ÿåˆ—ï¼ŒåŒæ—¶ï¼Œåœ¨è¿›å…¥ <code>scheduler</code> æµç¨‹æ—¶æŠŠ <code>Scheduler Priority</code> è®¾ç½®ä¸ºäº†æœ€é«˜ç­‰çº§ï¼Œç®€å•æ¥è¯´å°±æ˜¯éœ€è¦ç«‹å³æ‰§è¡Œçš„ä»»åŠ¡</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">scheduleSyncCallback</span>(<span class="params">callback: SchedulerCallback</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (syncQueue === <span class="literal">null</span>) &#123;</span><br><span class="line">    syncQueue = [callback];</span><br><span class="line">		<span class="comment">// çœŸæ­£çš„è°ƒåº¦å¼€å§‹</span></span><br><span class="line">    immediateQueueCallbackNode = Scheduler_scheduleCallback(</span><br><span class="line">      Scheduler_ImmediatePriority,</span><br><span class="line">      flushSyncCallbackQueueImpl,</span><br><span class="line">    );</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    syncQueue.push(callback);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> fakeCallbackNode;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>syncQueue</code> ä¼šé€šè¿‡ <code>flushSyncCallbackQueueImpl</code> éå†ï¼Œç„¶åé€ä¸ªæ‰§è¡Œå…¶ä¸­çš„ä»»åŠ¡ï¼Œè¿™ä¸ªæµç¨‹æ˜¯åœ¨ <code>react</code> å†…éƒ¨è¿›è¡Œ</p>
<p>è¿™å¬èµ·æ¥å¥½åƒæœ‰ç‚¹è°ƒåº¦çš„é—®é“ï¼Ÿæ˜¯çš„ï¼Œå…¶å®å¯¹äº <code>SyncLane</code> çš„ä»»åŠ¡ï¼Œ<code>react</code> ä¼šå¯¹å…¶å…ˆåšä¸€å±‚ä»»åŠ¡é˜Ÿåˆ—å°è£…ï¼Œå†æŠŠå¤„ç†ä»»åŠ¡é˜Ÿåˆ—çš„å‡½æ•°ä½œä¸ºä»»åŠ¡æŠ›ç»™ <code>Scheduler</code></p>
<p>è¿™æ˜¯ <code>scheduleSyncCallback</code> ç›¸å¯¹äº <code>scheduleCallback</code> æœ€å¤§çš„ä¸åŒç‚¹</p>
<h3 id="flushSyncCallbackQueueImpl"><a href="#flushSyncCallbackQueueImpl" class="headerlink" title="flushSyncCallbackQueueImpl"></a>flushSyncCallbackQueueImpl</h3><p>åœ¨ <code>scheduleSyncCallback</code> ä¸­æåˆ°è¿‡ï¼Œ<code>flushSyncCallbackQueueImpl</code> ç”¨æ¥éå† <code>syncQueue</code>ï¼Œæ‰§è¡Œ <code>callback</code>ï¼Œå®é™…å¯ä»¥ç†è§£ä¸ºå®ƒæ˜¯ä¸€ä¸ªåŒæ­¥ä»»åŠ¡è°ƒåº¦å™¨ï¼Œä¸åŒäº <code>Scheduler_scheduleCallback</code>ï¼Œ<code>flushSyncCallbackQueueImpl</code> åˆ©ç”¨çš„æ˜¯ <code>Scheduler</code> æä¾›çš„ <code>unstable_runWithPriority</code> å‡½æ•°æ¥è¿›è¡Œä»»åŠ¡è°ƒåº¦</p>
<p>å‡½æ•°å†…éƒ¨çš„ç»†èŠ‚ä¸å¿…è¿‡äºæ·±ç©¶ï¼Œæˆ‘ä»¬åªéœ€è¦çŸ¥é“å®ƒåšäº†è¿™æ ·ä¸€ä»¶äº‹ï¼š</p>
<p>éå† <code>syncQueue</code>ï¼Œåˆ©ç”¨çš„æ˜¯ <code>Scheduler</code> æä¾›çš„ <code>unstable_runWithPriority</code> å‡½æ•°æ¥æ‰§è¡Œ <code>callback</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">flushSyncCallbackQueueImpl</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!isFlushingSyncQueue &amp;&amp; syncQueue !== <span class="literal">null</span>) &#123;</span><br><span class="line">    isFlushingSyncQueue = <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">let</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (decoupleUpdatePriorityFromScheduler) &#123;</span><br><span class="line">      <span class="comment">// ... è¿™é‡Œæ˜¯reactçš„æ–°ç‰¹æ€§æµç¨‹ï¼Œç›®å‰ä¸è¿‡èµ°è¿™é‡Œ</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> isSync = <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">const</span> queue = syncQueue;</span><br><span class="line">        <span class="comment">// é€šè¿‡ runWithPriority æ¥æ‰§è¡Œ å•ä¸ªä»»åŠ¡</span></span><br><span class="line">        runWithPriority(ImmediatePriority, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">for</span> (; i &lt; queue.length; i++) &#123;</span><br><span class="line">            <span class="keyword">let</span> callback = queue[i];</span><br><span class="line">            <span class="keyword">do</span> &#123;</span><br><span class="line">              callback = callback(isSync);</span><br><span class="line">            &#125; <span class="keyword">while</span> (callback !== <span class="literal">null</span>);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        syncQueue = <span class="literal">null</span>;</span><br><span class="line">      &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">        <span class="comment">// å‘ç”ŸæŠ¥é”™æ—¶ï¼Œä¿ç•™å‰©ä½™çš„ä»»åŠ¡é˜Ÿåˆ—</span></span><br><span class="line">        <span class="keyword">if</span> (syncQueue !== <span class="literal">null</span>) &#123;</span><br><span class="line">          syncQueue = syncQueue.slice(i + <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// é€šè¿‡ scheduler è¿›è¡Œä»»åŠ¡æ¢å¤</span></span><br><span class="line">        Scheduler_scheduleCallback(</span><br><span class="line">          Scheduler_ImmediatePriority,</span><br><span class="line">          flushSyncCallbackQueue,</span><br><span class="line">        );</span><br><span class="line">        <span class="comment">// åŒæ—¶æŠ›å‡ºé”™è¯¯</span></span><br><span class="line">        <span class="keyword">throw</span> error;</span><br><span class="line">      &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        isFlushingSyncQueue = <span class="literal">false</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="reactPriorityToSchedulerPriority"><a href="#reactPriorityToSchedulerPriority" class="headerlink" title="reactPriorityToSchedulerPriority"></a>reactPriorityToSchedulerPriority</h3><p><code>reactPriorityToSchedulerPriority</code> çš„ä½œç”¨å°±æ˜¯æŠŠ <code>React</code> ä¸­çš„ä¼˜å…ˆçº§è½¬æ¢ä¸º <code>Scheduler</code> ä¸­çš„ä¼˜å…ˆçº§</p>
<p><code>React</code> ä¸­çš„ä¼˜å…ˆçº§ä¸»è¦ä»¥ä¸‹å‡ ç§</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> ImmediatePriority: ReactPriorityLevel = <span class="number">99</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> UserBlockingPriority: ReactPriorityLevel = <span class="number">98</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> NormalPriority: ReactPriorityLevel = <span class="number">97</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> LowPriority: ReactPriorityLevel = <span class="number">96</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> IdlePriority: ReactPriorityLevel = <span class="number">95</span>;</span><br><span class="line"><span class="comment">// React-only.</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> NoPriority: ReactPriorityLevel = <span class="number">90</span>;</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">reactPriorityToSchedulerPriority</span>(<span class="params">reactPriorityLevel</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">switch</span> (reactPriorityLevel) &#123;</span><br><span class="line">    <span class="keyword">case</span> ImmediatePriority:</span><br><span class="line">      <span class="keyword">return</span> Scheduler_ImmediatePriority;</span><br><span class="line">    <span class="keyword">case</span> UserBlockingPriority:</span><br><span class="line">      <span class="keyword">return</span> Scheduler_UserBlockingPriority;</span><br><span class="line">    <span class="keyword">case</span> NormalPriority:</span><br><span class="line">      <span class="keyword">return</span> Scheduler_NormalPriority;</span><br><span class="line">    <span class="keyword">case</span> LowPriority:</span><br><span class="line">      <span class="keyword">return</span> Scheduler_LowPriority;</span><br><span class="line">    <span class="keyword">case</span> IdlePriority:</span><br><span class="line">      <span class="keyword">return</span> Scheduler_IdlePriority;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      invariant(<span class="literal">false</span>, <span class="string">&#x27;Unknown priority level.&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>ä¸Šè¿°è¿‡ç¨‹åªæ˜¯ç®€å•æè¿°äº† <code>react</code> åˆ° <code>scheduler</code> çš„è¿‡æ¸¡æµç¨‹ï¼Œé€šè¿‡åˆ å‡åˆ†æ”¯æµç¨‹ï¼Œåªæ¢³ç†å‡ºå…¶ä¸­çš„ä¸»æµç¨‹ï¼Œå¯ä»¥æœ‰è¿™æ ·ä¸€ä¸ªå¤§è‡´æµç¨‹å›¾</p>
<p><img src="https://img.ninnka.top/1624714200073-react%20to%20scheduler.png"></p>
<h1 id="Scheduler-å¦‚ä½•è°ƒåº¦"><a href="#Scheduler-å¦‚ä½•è°ƒåº¦" class="headerlink" title="Scheduler å¦‚ä½•è°ƒåº¦"></a>Scheduler å¦‚ä½•è°ƒåº¦</h1><h2 id="å†™åœ¨å‰é¢"><a href="#å†™åœ¨å‰é¢" class="headerlink" title="å†™åœ¨å‰é¢"></a>å†™åœ¨å‰é¢</h2><p>ä¸ºäº†ä¾¿äºç†è§£ <code>Scheduler</code> å¦‚ä½•è°ƒåº¦ï¼Œéœ€è¦å…ˆäº†è§£å‡ ä¸ªåŸºæœ¬æ¦‚å¿µ</p>
<p>åœ¨ <code>Scheduler</code> ä¸­, ä»»åŠ¡è¢«åˆ†åœ¨äº†ä¸¤ä¸ªä¸åŒçš„é˜Ÿåˆ—ä¸­ï¼š</p>
<ul>
<li>å¾…è°ƒåº¦çš„é˜Ÿåˆ—ï¼Œä¹Ÿå«æœªè¿‡æœŸé˜Ÿåˆ— <code>timerQueue</code></li>
<li>è°ƒåº¦ä¸­çš„é˜Ÿåˆ—ï¼Œä¹Ÿå°±ä»»åŠ¡é˜Ÿåˆ— <code>taskQueue</code></li>
</ul>
<p>æ¯ä¸ª <code>task</code> éƒ½æœ‰ä¸€ä¸ª <code>expirationTime</code> â€œè¿‡æœŸæ—¶é—´â€ï¼Œ<code>expirationTime</code> ç”± <code>startTime</code> å’Œ <code>timeout</code> ç»„æˆï¼Œ<code>startTime</code> æ˜¯å®‰æ’è°ƒåº¦çš„å¼€å§‹æ—¶é—´</p>
<p>è¿™ä¸¤ç§é˜Ÿåˆ—æ€ä¹ˆåŒºåˆ†çš„å‘¢ï¼Ÿ</p>
<ul>
<li>å¦‚æœ <code>startTime</code> â€œå¼€å§‹æ—¶é—´â€ &gt; <code>currentTime</code> â€å½“å‰æ—¶é—´â€œï¼Œé‚£ä¹ˆä»»åŠ¡æ²¡æœ‰è¿‡æœŸï¼Œä»»åŠ¡â€æ¨å…¥â€œ <code>timerQueue</code></li>
<li>å¦‚æœ <code>currentTime</code> â€å½“å‰æ—¶é—´â€œ &gt;= <code>startTime</code> â€œå¼€å§‹æ—¶é—´â€ï¼Œé‚£ä¹ˆä»»åŠ¡å·²è¿‡æœŸï¼Œä»»åŠ¡â€œæ¨å…¥â€ <code>taskQueue</code></li>
</ul>
<p>ä¼ªä»£ç å¤§æ¦‚é•¿è¿™æ ·</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// currentTime å½“å‰æ—¶é—´</span></span><br><span class="line"><span class="comment">// expirationTime è¿‡æœŸæ—¶é—´</span></span><br><span class="line"><span class="keyword">if</span> (currentTime &gt;= startTime) &#123;</span><br><span class="line">  <span class="comment">// å·²è¿‡æœŸ</span></span><br><span class="line">  push(taskQueue, task);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="comment">// æœªè¿‡æœŸ</span></span><br><span class="line">  push(timerQueue, task);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è™½ç„¶éƒ½åœ¨ç”¨ <code>Queue</code> â€œé˜Ÿåˆ—â€ æ¥å‘½åå˜é‡ï¼Œä½†å®ƒä»¬å®é™…å¹¶ä¸æ˜¯å¤§å®¶æ™®éè®¤è¯†çš„é‚£ä¸ªé“¾è¡¨çº¿æ€§æ•°æ®ç»“æ„ï¼Œè¿™é‡Œç•™ä¸ªæ‚¬å¿µï¼Œåé¢æˆ‘ä»¬åœ¨è§£å¯†</p>
<div align="center">
<img width=200 src="https://img.ninnka.top/1624803961539-wenzhongdaipi.jpg"/>
</div>

<h2 id="unstable-scheduleCallback"><a href="#unstable-scheduleCallback" class="headerlink" title="unstable_scheduleCallback"></a>unstable_scheduleCallback</h2><p>å›åˆ°æ­£é¢˜ï¼Œå‰é¢è¯´åˆ° <code>react</code> ä¸­ä»»åŠ¡æˆ–è€…ä»»åŠ¡é˜Ÿåˆ—æœ€åä¼šé€šè¿‡è°ƒç”¨ <code>Scheduler_scheduleCallback</code> æ¥å¼€å¯è°ƒåº¦ï¼Œé‚£ä¹ˆ <code>Scheduler_scheduleCallback</code> æ˜¯æ€ä¹ˆå®ç°çš„å‘¢ï¼Ÿ</p>
<p><code>Scheduler_scheduleCallback</code> æœ¬èº«å°±å·²ç»ç›¸å½“ç®€æ´æ˜“æ‡‚äº†ï¼Œä»ä¸Šè‡³ä¸‹çš„é€»è¾‘æ²¡æœ‰æ–­å±‚ï¼Œè¯­ä¹‰é€šç•…</p>
<p><code>Scheduler_scheduleCallback</code> è´Ÿè´£è°ƒåº¦ä»»åŠ¡çš„åˆ›å»ºå’Œåˆ†é…ï¼Œè°ƒåº¦çš„å¯åŠ¨</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">unstable_scheduleCallback</span>(<span class="params">priorityLevel, callback, options</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> currentTime = getCurrentTime();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// -------------- è·å– â€œå¼€å§‹æ—¶é—´â€ startTime</span></span><br><span class="line">  <span class="keyword">var</span> startTime;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> options === <span class="string">&#x27;object&#x27;</span> &amp;&amp; options !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// delay æ˜¯ä¸»åŠ¨è®¾ç½®çš„ä»»åŠ¡å»¶æœŸæ—¶é•¿</span></span><br><span class="line">    <span class="keyword">var</span> delay = options.delay;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> delay === <span class="string">&#x27;number&#x27;</span> &amp;&amp; delay &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      startTime = currentTime + delay;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      startTime = currentTime;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    startTime = currentTime;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// --------------</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// -------------- æ ¹æ®ä¸åŒçš„ä¼˜å…ˆçº§è®¾ç½® â€œè¶…æ—¶æ—¶é—´â€ timeout</span></span><br><span class="line">  <span class="keyword">var</span> timeout;</span><br><span class="line">  <span class="keyword">switch</span> (priorityLevel) &#123;</span><br><span class="line">    <span class="keyword">case</span> ImmediatePriority:</span><br><span class="line">      timeout = IMMEDIATE_PRIORITY_TIMEOUT;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> UserBlockingPriority:</span><br><span class="line">      timeout = USER_BLOCKING_PRIORITY_TIMEOUT;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> IdlePriority:</span><br><span class="line">      timeout = IDLE_PRIORITY_TIMEOUT;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> LowPriority:</span><br><span class="line">      timeout = LOW_PRIORITY_TIMEOUT;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> NormalPriority:</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      timeout = NORMAL_PRIORITY_TIMEOUT;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// --------------</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// è®¾ç½®æˆªæ­¢æ—¶é—´</span></span><br><span class="line">  <span class="keyword">var</span> expirationTime = startTime + timeout;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// åˆ›å»ºæ–°çš„ task å¯¹è±¡</span></span><br><span class="line">  <span class="keyword">var</span> newTask = &#123;</span><br><span class="line">    id: taskIdCounter++,</span><br><span class="line">    callback,</span><br><span class="line">    priorityLevel,</span><br><span class="line">    <span class="comment">// ä¿å­˜äº†å¼€å§‹æ—¶é—´</span></span><br><span class="line">    startTime,</span><br><span class="line">    <span class="comment">// ä¿å­˜äº†æˆªæ­¢æ—¶é—´</span></span><br><span class="line">    expirationTime,</span><br><span class="line">    sortIndex: -<span class="number">1</span>,</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (startTime &gt; currentTime) &#123;</span><br><span class="line">    <span class="comment">// å¼€å§‹æ—¶é—´å¤§äºå½“å‰æ—¶é—´ï¼Œä»»åŠ¡æœªè¿‡æœŸ</span></span><br><span class="line">    newTask.sortIndex = startTime;</span><br><span class="line">    <span class="comment">// æ¨å…¥ timerQueue</span></span><br><span class="line">    push(timerQueue, newTask);</span><br><span class="line">    <span class="comment">// ------ æ£€æŸ¥æ˜¯å¦æœ‰æ‰§è¡Œä¸­çš„ hostTimtout</span></span><br><span class="line">    <span class="keyword">if</span> (peek(taskQueue) === <span class="literal">null</span> &amp;&amp; newTask === peek(timerQueue)) &#123;</span><br><span class="line">      <span class="keyword">if</span> (isHostTimeoutScheduled) &#123;</span><br><span class="line">        <span class="comment">// æœ‰çš„è¯å–æ¶ˆæ‰</span></span><br><span class="line">        cancelHostTimeout();</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        isHostTimeoutScheduled = <span class="literal">true</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// é‡æ–°å¯åŠ¨ hostTimeout</span></span><br><span class="line">      requestHostTimeout(handleTimeout, startTime - currentTime);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// ä»»åŠ¡å·²è¿‡æœŸ</span></span><br><span class="line">    newTask.sortIndex = expirationTime;</span><br><span class="line">    <span class="comment">// æ¨å…¥ taskQueue</span></span><br><span class="line">    push(taskQueue, newTask);</span><br><span class="line">    <span class="comment">// å¼€å§‹å¯åŠ¨è°ƒåº¦</span></span><br><span class="line">    <span class="keyword">if</span> (!isHostCallbackScheduled &amp;&amp; !isPerformingWork) &#123;</span><br><span class="line">      isHostCallbackScheduled = <span class="literal">true</span>;</span><br><span class="line">      requestHostCallback(flushWork);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// è¿”å›å½“å‰ task çš„å¼•ç”¨ï¼Œå¤–éƒ¨ä¼šè·å–è¿™ä¸ªç„¶åæŒ‚è½½åˆ° root èŠ‚ç‚¹ä¸Š</span></span><br><span class="line">  <span class="keyword">return</span> newTask;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ€»ç»“ä¸€ä¸‹ï¼Œ<code>Scheduler_scheduleCallback</code> ä¹Ÿå°±åšäº†è¿™å‡ ä»¶äº‹ï¼š</p>
<ul>
<li>è·å– â€œå¼€å§‹æ—¶é—´â€ startTime</li>
<li>æ ¹æ®ä¸åŒçš„ä¼˜å…ˆçº§è®¾ç½® â€œè¶…æ—¶æ—¶é—´â€ timeout</li>
<li>è®¾ç½®æˆªæ­¢æ—¶é—´</li>
<li>åˆ›å»ºæ–°çš„ task å¯¹è±¡</li>
<li>å¦‚æœä»»åŠ¡æœªè¿‡æœŸï¼ŒæŠŠä»»åŠ¡æ¨å…¥ <code>timerQueue</code>ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰æ‰§è¡Œä¸­çš„ <code>hostTimeout</code>ï¼Œæœ‰çš„è¯å–æ¶ˆæ‰ï¼Œé‡æ–°å¼€å¯ä¸€ä¸ª <code>hostTimeout</code></li>
<li>å¦‚æœä»»åŠ¡å·²è¿‡æœŸï¼ŒæŠŠä»»åŠ¡æ¨å…¥ <code>taskQueue</code>ï¼Œå¼€å§‹å¯åŠ¨è°ƒåº¦ <code>requestHostCallback(flushWork)</code>ï¼Œ<code>flushWork</code> æ˜¯çœŸæ­£éœ€è¦æ‰§è¡Œçš„å‡½æ•°</li>
</ul>
<p><img src="https://img.ninnka.top/1624778324759-Scheduler_scheduleCallback.png"></p>
<p>ç»†å¿ƒçš„å°ä¼™ä¼´åº”è¯¥å‘ç°äº†ï¼Œ<code>startTime</code> ç”¨æ¥åˆ¤æ–­ä»»åŠ¡æ˜¯å¦è¿‡æœŸï¼Œé‚£ä¹ˆ <code>expirationTime</code> å­˜åœ¨çš„æ„ä¹‰æ˜¯å•¥ï¼Ÿ</p>
<div align="center">
<img width=200 src="https://img.ninnka.top/1624953540463-xiaoxijie.jpg"/>
</div>

<h2 id="expirationTime-è¿‡æœŸæ—¶é—´"><a href="#expirationTime-è¿‡æœŸæ—¶é—´" class="headerlink" title="expirationTime è¿‡æœŸæ—¶é—´"></a>expirationTime è¿‡æœŸæ—¶é—´</h2><p>ä¸Šé¢æåˆ°äº† <code>startTime</code> æ˜¯ç”¨äºåˆ¤æ–­ä»»åŠ¡æ˜¯å¦å·²è¿‡æœŸï¼Œè®²é“ç†ä¼¼ä¹ä¸éœ€è¦ <code>expirationTime</code> è¿‡æœŸæ—¶é—´äº†</p>
<p>ä½†æ˜¯ <code>timerQueue</code> <code>taskQueue</code> æ˜¯ä¸ªé˜Ÿåˆ—å‘€ï¼Œä¸€ä¸ªé˜Ÿåˆ—é‡Œæ‰€æœ‰ä»»åŠ¡ä¸å¯èƒ½éƒ½æœ‰ä¸€æ ·çš„â€œä¼˜å…ˆçº§â€å§ğŸ˜</p>
<p>å¦‚æœæƒ³åŒºåˆ†ä¸€ä¸ªé˜Ÿåˆ—é‡Œä¸åŒä»»åŠ¡çš„ä¼˜å…ˆçº§ï¼Œç»™ä»–ä»¬æ’ä¸ªåºï¼Œé‚£è¦æ€ä¹ˆåŠå‘¢ï¼Œå…³é”®å°±åœ¨ <code>expirationTime</code> ä¸­äº†</p>
<p><code>expirationTime</code> ç”¨äºæ ‡è¯†ä¸€ä¸ªä»»åŠ¡å…·ä½“çš„è¿‡æœŸæ—¶é—´ï¼Œå½“å‰ä»»åŠ¡åœ¨1åˆ†é’Ÿåè¿‡æœŸè·Ÿ10åˆ†é’Ÿåè¿‡æœŸå…¶å®æœ¬è´¨ä¸Šéƒ½æ²¡æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Œå› ä¸ºéƒ½è¿˜æ²¡æœ‰è¿‡æœŸï¼Œä½†æ˜¯å…³é”®åœ¨äº10åˆ†é’Ÿåè¿‡æœŸçš„æƒ…å†µï¼Œå¯ä»¥æŠŠå½“å‰ä»»åŠ¡ç¨å¾®æ”¾ä¸€æ”¾ï¼ŒæŠŠèµ„æºå…ˆç»™å…¶ä»–ä»»åŠ¡æ‰§è¡Œ</p>
<p>è¿™ä¸ªå°±æ˜¯ <code>expirationTime</code> å­˜åœ¨çš„ç†ç”±</p>
<h2 id="push-timerQueue-newTask-amp-push-taskQueue-newTask"><a href="#push-timerQueue-newTask-amp-push-taskQueue-newTask" class="headerlink" title="push(timerQueue, newTask) &amp; push(taskQueue, newTask)"></a>push(timerQueue, newTask) &amp; push(taskQueue, newTask)</h2><p>ä»»åŠ¡ä¸ç®¡æ˜¯å¦è¿‡æœŸï¼Œéƒ½ä¼šé€šè¿‡ä¸€ä¸ª <code>push</code> æ–¹æ³•â€æ¨å…¥é˜Ÿåˆ—â€œä¸­</p>
<p>è¿™ä¸ª <code>push</code> å’‹çœ‹ä¸€ä¸‹å¾ˆåƒæ•°ç»„ä¸­å¸¸ç”¨çš„ <code>Array.prototype.push</code>ï¼Œä½†ç”±äº <code>timerQueue</code> å’Œ <code>taskQueue</code> çš„ç‰¹æ®Šç»“æ„ï¼Œ<code>push</code> å¹¶ä¸æ˜¯ç®€å•æ¨å…¥è€Œå·²</p>
<p><code>push</code> çš„ä»£ç ä¹Ÿæ˜¯ç›¸å½“ç®€æ´ï¼Œå½“ç„¶å¹¶ä¸æ˜¯å®ƒæ²¡åšä»€ä¹ˆäº‹ï¼Œåªæ˜¯å¯¹å‡½æ•°æ‹†åˆ†çš„éå¸¸ç»†</p>
<p><code>push</code> å‡½æ•°æ‰€åœ¨çš„æ–‡ä»¶æ˜¯ <code>react/packages/scheduler/src/SchedulerMinHeap.js</code></p>
<p>çœ‹åˆ°æ–‡ä»¶åï¼Œè‹¥æœ‰æ‰€æ€ï¼Ÿ</p>
<p>å„ä½è¿˜è®°å¾—å‰é¢æŒ–åˆ°å‘å—ï¼Œ<code>timerQueue</code> å’Œ <code>taskQueue</code> çš„ç‰¹æ®Šç»“æ„</p>
<p>ç²¾é€šæ•°æ®ç»“æ„ä¸ç®—æ³•çš„å°ä¼™ä¼´ä»¬è‚¯å®šå·²ç»å‘ç°äº†ï¼Œä¸¤ä¸ªé˜Ÿåˆ—éƒ½æ˜¯ç”¨ <code>æœ€å°å †</code> å®ç°çš„</p>
<div align="center">
<img width=120 src="https://img.ninnka.top/1624953504886-bukuishini.jpg"/>
</div>

<blockquote>
<p>æœ€å°å †ï¼Œæ˜¯ä¸€ç§ç»è¿‡æ’åºçš„å®Œå…¨äºŒå‰æ ‘ï¼Œå…¶ä¸­ä»»ä¸€éç»ˆç«¯èŠ‚ç‚¹çš„æ•°æ®å€¼å‡ä¸å¤§äºå…¶å·¦å­èŠ‚ç‚¹å’Œå³å­èŠ‚ç‚¹çš„å€¼ã€‚ â€”-ç™¾åº¦ç™¾ç§‘ã€‚</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">push</span>(<span class="params">heap: Heap, node: Node</span>): <span class="title">void</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> index = heap.length;</span><br><span class="line">  heap.push(node);</span><br><span class="line">  siftUp(heap, node, index);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œçš„ <code>heap</code> æ˜¯åˆ©ç”¨æ•°ç»„å®ç°çš„</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">type Heap = <span class="built_in">Array</span>&lt;Node&gt;;</span><br><span class="line">type Node = &#123;|</span><br><span class="line">  id: number,</span><br><span class="line">  sortIndex: number,</span><br><span class="line">|&#125;;</span><br></pre></td></tr></table></figure>

<p><code>æœ€å°å †</code> æœ‰ä¸¤ä¸ªæ¯”è¾ƒå…³é”®çš„æ“ä½œï¼Œä¸Šæµ®å’Œä¸‹å±‚</p>
<p>é€šè¿‡ä»£ç å¯ä»¥çœ‹å‡ºï¼Œæ–°å¢çš„èŠ‚ç‚¹æ˜¯pushåˆ°æ•°ç»„æœ€æœ«å°¾çš„ï¼Œè¦æ„æˆæœ€å°å †ï¼Œå°±éœ€è¦åˆ¤æ–­æ–°å¢çš„èŠ‚ç‚¹æ˜¯å¦æ»¡è¶³â€œæ•°æ®å€¼å‡ä¸å¤§äºå…¶å·¦å­èŠ‚ç‚¹å’Œå³å­èŠ‚ç‚¹çš„å€¼â€œè¿™ä¸€æ¡ä»¶</p>
<p>å¦‚æœä¸æ»¡è¶³ï¼Œåˆ™éœ€è¦æŠŠæ–°å¢çš„èŠ‚ç‚¹ä¸Šæµ®ï¼Œè¿™ä¸ªè¿‡ç¨‹åœ¨ <code>siftUp</code> ä¸­</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">siftUp</span>(<span class="params">heap, node, i</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> index = i;</span><br><span class="line">  <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">    <span class="comment">// è¿™é‡Œçš„é€šè¿‡æ— ç¬¦å·å³ç§»ä¸€ä½æ¥è·å–çˆ¶èŠ‚ç‚¹çš„index</span></span><br><span class="line">    <span class="keyword">const</span> parentIndex = (index - <span class="number">1</span>) &gt;&gt;&gt; <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">const</span> parent = heap[parentIndex];</span><br><span class="line">    <span class="keyword">if</span> (parent !== <span class="literal">undefined</span> &amp;&amp; compare(parent, node) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="comment">// çˆ¶èŠ‚ç‚¹å¤§äºå­èŠ‚ç‚¹</span></span><br><span class="line">      heap[parentIndex] = node;</span><br><span class="line">      heap[index] = parent;</span><br><span class="line">      index = parentIndex;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// çˆ¶èŠ‚ç‚¹å°äºå­èŠ‚ç‚¹ï¼Œé€€å‡º</span></span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç”±äºæœ¬æ–‡ä¸è¯¦ç»†è®¨è®ºæ•°æ®ç»“æ„ä¸ç®—æ³•ï¼Œåé¢æœ‰æœºä¼šå†å•ç‹¬å¼€ä¸€ç¯‡ç« åˆ†æ <code>æœ€å°å †</code> ğŸ˜</p>
<p><img src="https://img.ninnka.top/1624780291235-pushQueue%28minHeap%29.png"></p>
<h3 id="timeout"><a href="#timeout" class="headerlink" title="timeout"></a>timeout</h3><p>ä¸åŒä¼˜å…ˆçº§çš„ä»»åŠ¡æœ‰ä¸åŒçš„è¶…æ—¶æ—¶é—´ï¼Œå¯¹äºéœ€è¦ç«‹å³æ‰§è¡Œçš„ä»»åŠ¡å‘¢ï¼Ÿä¹Ÿä¼šæœ‰è¶…æ—¶æ—¶é—´å—ï¼Ÿ</p>
<p><code>Scheduler</code> ä¸­çš„è¶…æ—¶æ—¶é—´è®¾è®¡çš„æ¯”è¾ƒç‰¹åˆ«</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Math.pow(2, 30) - 1</span></span><br><span class="line"><span class="comment">// 0b111111111111111111111111111111</span></span><br><span class="line"><span class="keyword">var</span> maxSigned31BitInt = <span class="number">1073741823</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç«‹å³æ‰§è¡Œ</span></span><br><span class="line"><span class="keyword">var</span> IMMEDIATE_PRIORITY_TIMEOUT = -<span class="number">1</span>;</span><br><span class="line"><span class="comment">// å¸¸ç”¨è¶…æ—¶æ—¶é—´</span></span><br><span class="line"><span class="keyword">var</span> USER_BLOCKING_PRIORITY_TIMEOUT = <span class="number">250</span>;</span><br><span class="line"><span class="comment">// æ™®é€šä¼˜å…ˆçº§</span></span><br><span class="line"><span class="keyword">var</span> NORMAL_PRIORITY_TIMEOUT = <span class="number">5000</span>;</span><br><span class="line"><span class="comment">// ä½ä¼˜å…ˆçº§</span></span><br><span class="line"><span class="keyword">var</span> LOW_PRIORITY_TIMEOUT = <span class="number">10000</span>;</span><br><span class="line"><span class="comment">// æ°¸ä¸è¶…æ—¶</span></span><br><span class="line"><span class="keyword">var</span> IDLE_PRIORITY_TIMEOUT = maxSigned31BitInt;</span><br></pre></td></tr></table></figure>

<p>å¯¹äºéœ€è¦ç«‹å³æ‰§è¡Œçš„ä»»åŠ¡ï¼Œè¶…æ—¶æ—¶é—´æ˜¯-1ï¼Œé€šè¿‡-1å¯ä»¥ä½¿ <code>expirationTime</code> å°½å¯èƒ½å°ï¼Œä½¿å¾—ä»»åŠ¡ä¼˜å…ˆçº§æ›´é«˜ï¼Œåœ¨ <code>taskQueue</code> ä¸­çš„æ’åºä¹Ÿä¼šé å‰ï¼ˆé€šè¿‡æœ€å°å † <code>siftUp</code>ï¼‰</p>
<h2 id="requestHostTimeout-amp-cancelHostTimeout"><a href="#requestHostTimeout-amp-cancelHostTimeout" class="headerlink" title="requestHostTimeout &amp; cancelHostTimeout"></a>requestHostTimeout &amp; cancelHostTimeout</h2><p>åœ¨ <code>Scheduler_schedulerCallback</code> ä¸­ï¼Œæœªè¿‡æœŸçš„ä»»åŠ¡æµç¨‹ä¸­å‡ºç°äº†è¿™ä¸¤ä¸ªå¥‡æ€ªçš„å‡½æ•°ï¼Œç›¸ä¿¡ç¬¬ä¸€çœ¼çœ‹ä¸Šå»è‚¯å®šæ˜¯æ‡µé€¼ğŸ˜³çš„ï¼Œå› ä¸ºè¿™å‡½æ•°åç€å®è®©äººçŒœä¸é€ğŸ˜‚</p>
<p>çŒœä¸é€å°±ä¸çŒœäº†ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹å®ƒä»¬éƒ½åšäº†å•¥</p>
<p><strong>requestHostTimeout</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">requestHostTimeout = <span class="function"><span class="keyword">function</span>(<span class="params">callback, ms</span>) </span>&#123;</span><br><span class="line">  taskTimeoutID = <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    callback(getCurrentTime());</span><br><span class="line">  &#125;, ms);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><strong>cancelHostTimeout</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cancelHostTimeout = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="built_in">clearTimeout</span>(taskTimeoutID);</span><br><span class="line">  taskTimeoutID = -<span class="number">1</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>å¥½å®¶ä¼™ï¼Œè¿™ä¸¤ä¸ªåŸºå‹åˆç€å°±æ˜¯ä¸€ä¸ª <code>setTimeout</code> æ§åˆ¶å™¨</p>
<div align="center">
<img width=180 style="background: #fff" src="https://p3.pstatp.com/origin/pgc-image/3772c86f9b8a47b0b1844fbafb3ae8ca"/>
</div>

<p>çœ‹æ¥é‡ç‚¹ä¸åœ¨è¿™ä¸ª <code>setTimeout</code> ä¸Šï¼Œå›å¤´çœ‹çœ‹ <code>Scheduler_schedulerCallback</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">requestHostTimeout(handleTimeout, startTime - currentTime);</span><br></pre></td></tr></table></figure>

<p>ç¬¬äºŒä¸ªæ˜¯ <code>timeout</code> æ—¶é•¿ï¼Œç¬¬ä¸€ä¸ªåº”è¯¥å°±æ˜¯å›è°ƒå‡½æ•°äº†ï¼Œå«£ç„¶å›é¦–ï¼Œé‚£äººå´åœ¨ç¯ç«é˜‘çŠå¤„</p>
<p>å¥½å®¶ä¼™ï¼Œé‡ç‚¹åŸæ¥æ˜¯ä½  <code>handleTimeout</code></p>
<h2 id="handleTimeout"><a href="#handleTimeout" class="headerlink" title="handleTimeout"></a>handleTimeout</h2><p>è¿™å‡½æ•°ä¹Ÿæ˜¯çŸ­å°ç²¾æ‚ï¼Œåˆ°è¿™é‡Œè™½ç„¶ç»•äº†ä¸ªè¿œè·¯ï¼Œä¸è¿‡ä¸è¦ç´§ï¼Œæˆ‘ä»¬å…ˆå¥½å¥½äº¤æµâ™‚</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">handleTimeout</span>(<span class="params">currentTime</span>) </span>&#123;</span><br><span class="line">  isHostTimeoutScheduled = <span class="literal">false</span>;</span><br><span class="line">  advanceTimers(currentTime);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// åˆ¤æ–­æ˜¯å¦å·²å¯åŠ¨è°ƒåº¦ä»»åŠ¡å›è°ƒ</span></span><br><span class="line">  <span class="keyword">if</span> (!isHostCallbackScheduled) &#123;</span><br><span class="line">    <span class="keyword">if</span> (peek(taskQueue) !== <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="comment">// å½“å‰ è°ƒåº¦ä¸­çš„é˜Ÿåˆ— ä¸ä¸ºç©º</span></span><br><span class="line">      isHostCallbackScheduled = <span class="literal">true</span>;</span><br><span class="line">      <span class="comment">// å¯åŠ¨è°ƒåº¦ä»»åŠ¡å›è°ƒ</span></span><br><span class="line">      requestHostCallback(flushWork);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// å¦‚æœ å½“å‰ è°ƒåº¦ä¸­çš„é˜Ÿåˆ— ä¸ºç©º</span></span><br><span class="line">      <span class="comment">// è·å–å¾…è°ƒåº¦çš„ä»»åŠ¡ä¸­çš„ç¬¬ä¸€ä¸ª</span></span><br><span class="line">      <span class="keyword">const</span> firstTimer = peek(timerQueue);</span><br><span class="line">      <span class="keyword">if</span> (firstTimer !== <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// è®¡ç®—å¾…è°ƒåº¦çš„ä»»åŠ¡è·ç¦»ç°åœ¨è¿˜æœ‰å¤šä¹…æ‰ä¼šå¼€å§‹è¿›å…¥è°ƒåº¦ï¼Œå¹¶è®¾ç½®ä¸ºtimeoutå‚æ•°</span></span><br><span class="line">        <span class="comment">// é‡æ–°æ‰§è¡Œ handleTimeout</span></span><br><span class="line">        requestHostTimeout(handleTimeout, firstTimer.startTime - currentTime);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬å…ˆæ¥åˆ†æä»£ç çœ‹çœ‹å®ƒåšäº†å•¥</p>
<ul>
<li>æ‰§è¡Œ <code>advanceTimers</code></li>
<li>åˆ¤æ–­æ˜¯å¦å·²å¯åŠ¨è°ƒåº¦ä»»åŠ¡å›è°ƒ</li>
<li>å¦‚æœå½“å‰ è°ƒåº¦ä¸­çš„é˜Ÿåˆ— ä¸ä¸ºç©ºå¹¶ä¸”æœ‰è°ƒåº¦ä¸­çš„ä»»åŠ¡ï¼Œé‚£ä¹ˆå¯åŠ¨è°ƒåº¦ä»»åŠ¡å›è°ƒ</li>
<li>å¦‚æœå½“å‰ è°ƒåº¦ä¸­çš„é˜Ÿåˆ— ä¸ºç©ºï¼Œè·å–å¾…è°ƒåº¦çš„ä»»åŠ¡ä¸­çš„ç¬¬ä¸€ä¸ªï¼Œè®¡ç®—å¾…è°ƒåº¦çš„ä»»åŠ¡è·ç¦»ç°åœ¨è¿˜æœ‰å¤šä¹…æ‰ä¼šå¼€å§‹è¿›å…¥è°ƒåº¦ï¼Œå¹¶è®¾ç½®ä¸ºtimeoutå‚æ•°ï¼Œé‡æ–°æ‰§è¡Œ <code>handleTimeout</code></li>
</ul>
<p>å’‹çœ‹ä¸€ä¸‹ï¼Œæˆ‘ä»¬å¥½åƒæŠŠ <code>handleTimeout</code> åˆ†æå®Œäº†ğŸ¤”ï¼Œä½†æ˜¯è¿˜å­˜åœ¨ä¸å°‘ç–‘ç‚¹</p>
<ul>
<li><code>advanceTimers</code> æ˜¯ä»€ä¹ˆ</li>
<li>åˆè§åˆ°äº† <code>requestHostCallback</code>ï¼Œå®ƒå…·ä½“åšäº†ä»€ä¹ˆ</li>
<li>ä¸ºä»€ä¹ˆ â€è®¡ç®—å¾…è°ƒåº¦çš„ä»»åŠ¡è·ç¦»ç°åœ¨è¿˜æœ‰å¤šä¹…æ‰ä¼šå¼€å§‹è¿›å…¥è°ƒåº¦ï¼Œå¹¶è®¾ç½®ä¸º timeout å‚æ•°â€œï¼Œç„¶å â€é‡æ–°æ‰§è¡Œ handleTimeoutâ€œ</li>
</ul>
<p>ç»¼åˆä»¥ä¸Šå‡ ä¸ªç–‘ç‚¹ï¼Œè®¿é—®è¿™ä¸ªå‡½æ•°æœ€æœ€æœ€å…³é”®çš„æµç¨‹åœ¨äº</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (peek(taskQueue) !== <span class="literal">null</span>) &#123;</span><br><span class="line">  <span class="comment">// å½“å‰ è°ƒåº¦ä¸­çš„é˜Ÿåˆ— ä¸ä¸ºç©º</span></span><br><span class="line">  isHostCallbackScheduled = <span class="literal">true</span>;</span><br><span class="line">  <span class="comment">// å¯åŠ¨è°ƒåº¦ä»»åŠ¡å›è°ƒ</span></span><br><span class="line">  requestHostCallback(flushWork);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åšäº†è¿™ä¹ˆå¤šéªšæ“ä½œä¼¼ä¹éƒ½æ˜¯ä¸ºäº†èƒ½è¿›å…¥åˆ°è¿™ä¸ªæµç¨‹é‡Œï¼Œå›å¤´çœ‹çœ‹ <code>else</code> ä¸­çš„æµç¨‹</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="comment">// å¦‚æœ å½“å‰ è°ƒåº¦ä¸­çš„é˜Ÿåˆ— ä¸ºç©º</span></span><br><span class="line">  <span class="comment">// è·å–å¾…è°ƒåº¦çš„ä»»åŠ¡ä¸­çš„ç¬¬ä¸€ä¸ª</span></span><br><span class="line">  <span class="keyword">const</span> firstTimer = peek(timerQueue);</span><br><span class="line">  <span class="keyword">if</span> (firstTimer !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// è®¡ç®—å¾…è°ƒåº¦çš„ä»»åŠ¡è·ç¦»ç°åœ¨è¿˜æœ‰å¤šä¹…æ‰ä¼šå¼€å§‹è¿›å…¥è°ƒåº¦ï¼Œå¹¶è®¾ç½®ä¸ºtimeoutå‚æ•°</span></span><br><span class="line">    <span class="comment">// é‡æ–°æ‰§è¡Œ handleTimeout</span></span><br><span class="line">    requestHostTimeout(handleTimeout, firstTimer.startTime - currentTime);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸ºä»€ä¹ˆ â€è®¡ç®—å¾…è°ƒåº¦çš„ä»»åŠ¡è·ç¦»ç°åœ¨è¿˜æœ‰å¤šä¹…æ‰ä¼šå¼€å§‹è¿›å…¥è°ƒåº¦ï¼Œå¹¶è®¾ç½®ä¸º timeout å‚æ•°â€œï¼Œç„¶å â€é‡æ–°æ‰§è¡Œ handleTimeoutâ€œï¼Œ<code>handleTimeout</code> å°±èƒ½è¿›å…¥åˆ° <code>if</code> çš„æµç¨‹ä¸­äº†å‘¢ï¼Ÿ</p>
<p><code>if</code> å’Œ <code>else</code> éƒ½æ²¡æ‰¾åˆ°ç­”æ¡ˆï¼Œæ˜¾ç„¶æˆ‘ä»¬åº”è¯¥å…ˆç…ç… <code>advanceTimers</code> æ˜¯ä½•æ–¹ç¥åœ£</p>
<h2 id="advanceTimers"><a href="#advanceTimers" class="headerlink" title="advanceTimers"></a>advanceTimers</h2><p><code>advanceTimers</code> ä»å‡½æ•°åä¸Šç†è§£çš„è¯ï¼Œå¤§æ¦‚æ˜¯æŠŠ <code>timers</code> æå‰çš„æ„æ€</p>
<p>æå‰ <code>timers</code>ï¼Ÿä½¿ <code>timers</code> æå‰è¿è¡Œï¼Ÿä½¿ <code>timers</code> å¾…è°ƒåº¦çš„ä»»åŠ¡æå‰æ‰§è¡Œï¼Ÿ</p>
<p>ä¼¼ä¹æœ‰ç‚¹é‚£å‘³äº†ï¼Œæˆ‘ä»¬è¿˜æ˜¯æ¥çœ‹çœ‹ä»£ç </p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">advanceTimers</span>(<span class="params">currentTime</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// è·å–ç¬¬ä¸€ä¸ªå¾…è°ƒåº¦çš„ä»»åŠ¡</span></span><br><span class="line">  <span class="keyword">let</span> timer = peek(timerQueue);</span><br><span class="line">  <span class="keyword">while</span> (timer !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// å¦‚æœä»»åŠ¡ä¸ä¸ºç©º</span></span><br><span class="line">    <span class="keyword">if</span> (timer.callback === <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="comment">// æ²¡æœ‰ callback è¯´æ˜å·²ç»æ‰§è¡Œå®Œäº†æˆ–è€…æ˜¯ä¸ªç©ºä»»åŠ¡ï¼Œç›´æ¥å¿½ç•¥</span></span><br><span class="line">      pop(timerQueue);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (timer.startTime &lt;= currentTime) &#123;</span><br><span class="line">      <span class="comment">// ä»»åŠ¡è¶…æ—¶äº†ï¼Œéœ€è¦æ‰§è¡Œäº†</span></span><br><span class="line">      pop(timerQueue);</span><br><span class="line">      <span class="comment">// æ ‡è®°æ’åºç”¨çš„æ ‡è¯†</span></span><br><span class="line">      timer.sortIndex = timer.expirationTime;</span><br><span class="line">      <span class="comment">// æŠŠ timer ç§»åŠ¨åˆ° taskQueue</span></span><br><span class="line">      push(taskQueue, timer);</span><br><span class="line">      <span class="comment">// ....</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å¦‚æœå‡ºç°æœ‰ä»»åŠ¡è¢«ç§»åŠ¨æˆ–è€…ç§»é™¤çš„æƒ…å†µï¼Œæ£€æŸ¥ä¸‹ä¸€ä¸ª timer</span></span><br><span class="line">    timer = peek(timerQueue);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ€»ç»“ä¸€ä¸‹åšäº†å•¥äº‹ï¼š</p>
<ul>
<li>è·å–ç¬¬ä¸€ä¸ªå¾…è°ƒåº¦çš„ä»»åŠ¡ï¼Œå¹¶ä¸”ä»»åŠ¡ä¸ä¸ºç©º</li>
<li>åˆ¤æ–­æ˜¯å¦æœ‰callbackï¼Œæ²¡æœ‰ callback è¯´æ˜å·²ç»æ‰§è¡Œå®Œäº†æˆ–è€…æ˜¯ä¸ªç©ºä»»åŠ¡ï¼Œç›´æ¥å¿½ç•¥</li>
<li>åˆ¤æ–­ä»»åŠ¡æ˜¯å¦è¶…æ—¶ï¼Œè¶…æ—¶çš„æƒ…å†µä» <code>timerQueue</code> å–å‡ºæ¥ï¼Œ<code>push</code> åˆ° <code>taskQueue</code>ï¼Œå¹¶æ›´æ–°æ’åºæ ‡è®°</li>
<li>å¦‚æœå‡ºç°æœ‰ä»»åŠ¡è¢«ç§»åŠ¨æˆ–è€…ç§»é™¤çš„æƒ…å†µï¼Œæ£€æŸ¥ä¸‹ä¸€ä¸ª timer</li>
</ul>
<p>è™½è¯´ <code>advanceTimers</code> æ˜¯ä¸ª <code>while</code> å¾ªç¯ï¼Œä½†æ˜¯è§¦å‘æ¡ä»¶å¿…é¡»åœ¨ <code>taskQueue</code> ä¸ºç©ºçš„æ—¶å€™</p>
<p>ç»¼ä¸Šæ‰€è¿°ï¼Œ<code>advanceTimers</code> å…¶å®æ˜¯ä»»åŠ¡åˆ†é…å™¨ï¼Œç”¨äºâ€æŠŠä¸éœ€è¦å†ç­‰å¾…è°ƒåº¦çš„ä»»åŠ¡ä» <code>timerQueue</code> ç§»åŠ¨åˆ° <code>taskQueue</code>â€œï¼ˆè¿™ä¹Ÿè·Ÿæä¸æå‰æ²¡å•¥å…³ç³»å‘€ï¼Œç¡®å®æ²¡å•¥å…³ç³»ï¼‰</p>
<p>æŠŠ <code>advanceTimers</code> å’Œ <code>handleTimeout</code> çš„ç»“åˆèµ·æ¥é‡æ–°æ€è€ƒä¸‹ï¼Œå®ƒä»¬çš„æµç¨‹å¤§æ¦‚æ˜¯è¿™æ ·çš„</p>
<p><img src="https://img.ninnka.top/1624786716030-handleTimeout.png"></p>
<p><img src="https://img.ninnka.top/1624786804192-advanceTimers.png"></p>
<h2 id="requestHostCallback"><a href="#requestHostCallback" class="headerlink" title="requestHostCallback"></a>requestHostCallback</h2><p>ç»“æŸäº† <code>hostTimeout</code> å’Œ <code>timers</code> çš„æ©æ©æ€¨æ€¨ï¼Œæˆ‘ä»¬å›è¿‡å¤´æ¥åˆ†æä¸‹ <code>requestHostCallback</code></p>
<p><code>requestHostCallback</code> æ˜¯è°ƒåº¦çš„ç¬¬ä¸€æ­¥ï¼šæ³¨å†Œä»»åŠ¡ï¼Œå¹¶é€šçŸ¥è°ƒç”¨</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">requestHostCallback = <span class="function"><span class="keyword">function</span>(<span class="params">callback</span>) </span>&#123;</span><br><span class="line">  scheduledHostCallback = callback;</span><br><span class="line">  <span class="keyword">if</span> (!isMessageLoopRunning) &#123;</span><br><span class="line">    isMessageLoopRunning = <span class="literal">true</span>;</span><br><span class="line">    port.postMessage(<span class="literal">null</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>ä»£ç å¾ˆç®€å•ï¼Œæˆ‘ä»¬å…ˆåˆ†æè®°å½•ä¸€ä¸‹</p>
<ul>
<li>ä¿å­˜ä»»åŠ¡åˆ° <code>scheduledHostCallback</code></li>
<li>æ ‡è®° <code>isMessageLoopRunning</code>ï¼Œæ ‡è®°æ¶ˆæ¯è½®è¯¢å¼€å§‹</li>
<li><code>port.postMessage(null)</code> å‘é€ä¸€ä¸ªæ¶ˆæ¯é€šçŸ¥</li>
</ul>
<p>è¿™ä¸ªæµç¨‹ä¸­çš„å…³é”®åº”è¯¥åœ¨äº <code>scheduledHostCallback</code> å’Œ <code>port.postMessage(null)</code></p>
<p>ä½†æ˜¯ <code>scheduledHostCallback</code> ç”¨åœ¨å“ªé‡Œï¼Ÿ<code>port.postMessage(null)</code> ä¸­çš„ <code>port</code> æ˜¯ä»€ä¹ˆï¼Œæ¶ˆæ¯å‘ç»™è°ï¼Œæ˜¯ä¸ºäº†åšä»€ä¹ˆï¼Ÿ</p>
<p>å¸¦ç€é—®é¢˜æˆ‘ä»¬ç»§ç»­å¾€ä¸‹çœ‹</p>
<p><code>requestHostCallback</code> åœ¨ <code>react/packages/scheduler/src/forks/SchedulerHostConfig.default.js</code> ä¸­</p>
<p>è§‚å¯Ÿæ–‡ä»¶ä¸­ä»£ç ï¼Œå¯ä»¥å‘ç°ï¼Œè¿™ä¸ªæ–‡ä»¶åˆæ¬¡æ‰§è¡Œæ—¶ï¼Œä¼šåˆå§‹åŒ– <code>requestHostTimeout</code> <code>cancelHostTimeout</code> <code>requestHostCallback</code> <code>performWorkUntilDeadline</code>   <code>forceFrameRate</code> ç­‰å‡½æ•°</p>
<p><code>requestHostTimeout</code> <code>cancelHostTimeout</code> ç°åœ¨åº”è¯¥éƒ½æœ‰äº†è§£äº†</p>
<p>ä½†æ˜¯ <code>requestHostCallback</code> <code>performWorkUntilDeadline</code>  <code>forceFrameRate</code> <code>shouldYieldToHost</code> å°±å¾ˆé™Œç”Ÿ</p>
<p>åˆ«æ‹…å¿ƒï¼Œç›´è§‰å‘Šè¯‰æˆ‘ï¼Œåˆšåˆšé—®é¢˜çš„ç­”æ¡ˆå¾ˆå¯èƒ½åœ¨ <code>performWorkUntilDeadline</code> é‡Œ</p>
<h2 id="performWorkUntilDeadline"><a href="#performWorkUntilDeadline" class="headerlink" title="performWorkUntilDeadline"></a>performWorkUntilDeadline</h2><p>ä»å‡½æ•°åä¸Šåˆ†æå¤§æ¦‚å¯ä»¥çŸ¥é“ï¼Œè¿™ä¸ªå‡½æ•°ä¼šç”¨æ¥å¤„ç†ä»»åŠ¡ä¸­çš„ callbackï¼Œç›´åˆ°ä»»åŠ¡è¶…è¿‡æœ€å¤§å¯æ‰§è¡Œæ—¶é•¿</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> channel = <span class="keyword">new</span> MessageChannel();</span><br><span class="line"><span class="keyword">const</span> port = channel.port2;</span><br><span class="line">channel.port1.onmessage = performWorkUntilDeadline;</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> performWorkUntilDeadline = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (scheduledHostCallback !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> currentTime = getCurrentTime();</span><br><span class="line">    <span class="comment">// æˆªæ­¢æ—¶é—´ç‚¹ï¼Œåœ¨å½“å‰æ—¶é—´ä¸ŠåŠ  yieldInterval</span></span><br><span class="line">    <span class="comment">// yieldInterval å¯ä»¥ç†è§£ä¸ºæœ€å¤§å¯æ‰§è¡Œæ—¶é•¿ï¼Œä¹Ÿå°±æ˜¯å¸¸è¯´çš„æ—¶é—´åˆ‡ç‰‡ï¼Œæ¯ç‰‡5ms</span></span><br><span class="line">    deadline = currentTime + yieldInterval;</span><br><span class="line">    <span class="comment">// æ˜¯å¦æœ‰å‰©ä½™æ—¶é—´</span></span><br><span class="line">    <span class="keyword">const</span> hasTimeRemaining = <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// è°ƒç”¨äº† scheduledHostCallbackï¼Œå¹¶ä¿å­˜è¿”å›ç»“æœ</span></span><br><span class="line">      <span class="keyword">const</span> hasMoreWork = scheduledHostCallback(</span><br><span class="line">        hasTimeRemaining,</span><br><span class="line">        currentTime,</span><br><span class="line">      );</span><br><span class="line">      <span class="keyword">if</span> (!hasMoreWork) &#123;</span><br><span class="line">        <span class="comment">// å¦‚æœ scheduledHostCallback è¿”å› falseï¼Œé‚£ä¹ˆä»»åŠ¡ç»“æŸ</span></span><br><span class="line">        isMessageLoopRunning = <span class="literal">false</span>;</span><br><span class="line">        scheduledHostCallback = <span class="literal">null</span>;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// å¦‚æœ scheduledHostCallback è¿”å›ä¸ä¸º falseï¼Œé‚£ä¹ˆå‘é€æ¶ˆæ¯ï¼Œé‡æ–°è°ƒåº¦æ‰§è¡Œ</span></span><br><span class="line">        port.postMessage(<span class="literal">null</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">      <span class="comment">// å¦‚æœ scheduledHostCallback è¿”å›ä¸ä¸º falseï¼Œé‚£ä¹ˆå‘é€æ¶ˆæ¯ï¼Œé‡æ–°è°ƒåº¦æ‰§è¡Œï¼Œå¹¶æŠ›å‡ºé”™è¯¯</span></span><br><span class="line">      port.postMessage(<span class="literal">null</span>);</span><br><span class="line">      <span class="keyword">throw</span> error;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    isMessageLoopRunning = <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  needsPaint = <span class="literal">false</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>æœä¸å…¶ç„¶ï¼Œ<code>performWorkUntilDeadline</code> ä¸­æ§åˆ¶äº† <code>scheduledHostCallback</code> çš„æ‰§è¡Œ</p>
<p>åˆ†ææ€»ç»“ä¸€ä¸‹ï¼šè¿™é‡Œåˆ†ä¸ºä¸¤éƒ¨åˆ†</p>
<p>ç¬¬ä¸€éƒ¨åˆ†ï¼š</p>
<ul>
<li>åˆ›å»ºä¸€ä¸ª <code>MessageChannel</code> å®ä¾‹</li>
<li>ä¸º <code>port1.onmessage</code> æ³¨å†Œ <code>performWorkUntilDeadline</code></li>
</ul>
<p>ç¬¬äºŒéƒ¨åˆ†ï¼š</p>
<ul>
<li>è®¾ç½®æˆªæ­¢æ—¶é—´ç‚¹ï¼Œåœ¨å½“å‰æ—¶é—´ä¸ŠåŠ  <code>yieldInterval</code>ï¼Œ<code>yieldInterval</code> å¯ä»¥ç†è§£ä¸ºæœ€å¤§å¯æ‰§è¡Œæ—¶é•¿ï¼Œä¹Ÿå°±æ˜¯å¸¸è¯´çš„æ—¶é—´åˆ‡ç‰‡ï¼Œæ¯ç‰‡5ms</li>
<li>è°ƒç”¨äº† scheduledHostCallbackï¼Œå¹¶ä¿å­˜è¿”å›ç»“æœ</li>
<li>å¦‚æœ scheduledHostCallback è¿”å› falseï¼Œé‚£ä¹ˆä»»åŠ¡ç»“æŸ</li>
<li>å¦‚æœ scheduledHostCallback è¿”å›ä¸ä¸º falseï¼Œé‚£ä¹ˆå‘é€æ¶ˆæ¯ï¼Œé‡æ–°è°ƒåº¦æ‰§è¡Œ</li>
<li>å¦‚æœ scheduledHostCallback è¿”å›ä¸ä¸º falseï¼Œé‚£ä¹ˆå‘é€æ¶ˆæ¯ï¼Œé‡æ–°è°ƒåº¦æ‰§è¡Œï¼Œå¹¶æŠ›å‡ºé”™è¯¯</li>
<li><code>isMessageLoopRunning</code> ç½®ä¸º falseï¼Œæ ‡è®°æ¶ˆæ¯è½®è¯¢ç»“æŸ</li>
</ul>
<p>ç»†å¿ƒçš„å°ä¼™ä¼´åº”è¯¥å‘ç°äº†ï¼Œ<code>port1.onmessage = performWorkUntilDeadline</code>ï¼Œåœ¨ <code>performWorkUntilDeadline</code> ä¸­è°ƒç”¨ <code>port.postMessage(null)</code>ï¼Œä¸æ˜¯ä¼šè§¦å‘ <code>performWorkUntilDeadline</code> çš„æ‰§è¡Œå—ï¼Ÿï¼Ÿï¼Ÿ</p>
<p>æ˜¯çš„ï¼Œæ²¡é”™ï¼è¿™å°±æ˜¯å®ç°æ¢å¤æ‰§è¡Œçš„ç¬¬ä¸€æ­¥ï¼Œåˆ°æ­¤è¿˜ä¸ç®—æ¢å¤ä¸­æ–­ä»»åŠ¡ï¼Œå…ˆç•™ä¸ªå‘æ¥ç€å¾€ä¸‹çœ‹</p>
<h2 id="MessageChannel"><a href="#MessageChannel" class="headerlink" title="MessageChannel"></a>MessageChannel</h2><p>å¤§å®¶è‚¯å®šå¬è¯´è¿‡ <code>requestIdleCallback</code>ï¼Œ<code>requestAnimationFrame</code>ï¼Œä½†æ˜¯è¿™ä¸¤ä¸ª api çš„ä¸ç¨³å®šè®© <code>Scheduler</code> æ”¾å¼ƒäº†å®ƒä»¬ï¼Œæœ€ç»ˆåˆ©ç”¨ <code>MessageChannel</code> æ¥äººä¸ºæ§åˆ¶è°ƒåº¦é¢‘ç‡ï¼Œè¿™ä¸ªè°ƒåº¦é¢‘ç‡å¯ä»¥ç†è§£ä¸ºæ¯ä¸ªä»»åŠ¡çš„å¯æ‰§è¡Œæœ€å¤§æ—¶é•¿</p>
<p>è¯´åˆ°è¿™é‡Œå¯èƒ½å¤§å®¶å¯¹ <code>MessageChannel</code> è¿˜æ˜¯ä¸äº†è§£ï¼Œå¯ä»¥å›æƒ³ä¸‹ <code>iframe</code>ï¼Œä¸çˆ¶é¡µé¢é€šä¿¡æ—¶ï¼Œé€šå¸¸ä¼šä½¿ç”¨ <code>postMessage</code>ï¼Œå®ƒä»¬çš„å…¼å®¹æ€§æ˜¯çœŸçš„å¥½</p>
<p><img src="https://img.ninnka.top/1624794783571.png"></p>
<p>è€Œä¸”ç”¨èµ·æ¥ä¹Ÿç®€å•</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> channel = <span class="keyword">new</span> MessageChannel();</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">handleMessage</span>(<span class="params">e</span>) </span>&#123;</span><br><span class="line">  alert(e.data);</span><br><span class="line">&#125;</span><br><span class="line">channel.port1.onmessage = handleMessage;</span><br><span class="line">channel.port2.postMessage(<span class="string">&#x27;hello react scheduler~&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p><img src="https://img.ninnka.top/1624795445360.png"></p>
<p><code>MessageChannel</code> çš„ä»»åŠ¡æ˜¯ <code>macrotask</code>ï¼Œä¼˜å…ˆçº§è¦æ¯” <code>Promise</code> ä½</p>
<p><img src="https://img.ninnka.top/1624795518834.png"></p>
<p>è¿™ä¸ª <code>MessageChannel</code> åŒæ ·å¯ä»¥ä½¿ç”¨ <code>postMessage</code> åœ¨ä¸¤ä¸ªç«¯å£ä¹‹é—´å®ç°é€šä¿¡ï¼Œå…·ä½“å¯ä»¥è‡ªè¡ŒæŸ¥é˜…<a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/API/MessageChannel/MessageChannel">MDN-MessageChannel</a></p>
<h2 id="yieldInterval-amp-forceFrameRate"><a href="#yieldInterval-amp-forceFrameRate" class="headerlink" title="yieldInterval &amp; forceFrameRate"></a>yieldInterval &amp; forceFrameRate</h2><p>ç»ˆäºåˆ°å¤§å®¶éƒ½ç†ŸçŸ¥çš„â€æ—¶é—´åˆ‡ç‰‡â€œäº†ğŸ˜„ï¼Œæ¯ä¸ªä»»åŠ¡çš„å¯æ‰§è¡Œæœ€å¤§æ—¶é•¿é»˜è®¤è®¾ç½®ä¸º 5msï¼Œæ¯å¸§16msæ€»æ—¶é•¿ï¼Œä»»åŠ¡æ‰§è¡Œå 5msï¼Œé…åˆ <code>MessageChannel</code> åç²’åº¦æ§åˆ¶æ¯”èµ·åŸç”Ÿçš„ <code>requestIdleCallback</code>ï¼Œ<code>requestAnimationFrame</code> è¦ç¨³å®šçš„å¤šäº†ã€‚</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// é»˜è®¤ä¸º 5ms</span></span><br><span class="line"><span class="keyword">let</span> yieldInterval = <span class="number">5</span>;</span><br></pre></td></tr></table></figure>

<p>å‰é¢æåˆ°äº† <code>yieldInterval</code> é»˜è®¤ä¸º 5ms æ˜¯å¯¹äº 60Hz åˆ·æ–°ç‡çš„æ˜¾ç¤ºå™¨ï¼Œè¿™ä¸ªå¯èƒ½è¿˜ä¸é”™ï¼Œä½†æ˜¯å¯¹äºåˆ·æ–°ç‡åº•çš„æ˜¾ç¤ºå™¨ï¼Œå¯èƒ½å°±æ˜¯é‚£ä¹ˆåˆç†äº†</p>
<p>æ‰€ä»¥ï¼Œ<code>Scheduler</code> å†…éƒ¨ä¼šè‡ªè¡Œè®¾ç½® <code>yieldInterval</code> çš„æ–¹æ³•ï¼Œå½“ç„¶ä¹Ÿæä¾›äº†å…¥å£è®©å¤–éƒ¨è®¾ç½®</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å¯ä»¥è‡ªè¡Œè®¾ç½® fpsï¼ŒèŒƒå›´åœ¨ 0 ~ 125</span></span><br><span class="line">forceFrameRate = <span class="function"><span class="keyword">function</span>(<span class="params">fps</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (fps &lt; <span class="number">0</span> || fps &gt; <span class="number">125</span>) &#123;</span><br><span class="line">    <span class="built_in">console</span>[<span class="string">&#x27;error&#x27;</span>](</span><br><span class="line">      <span class="string">&#x27;forceFrameRate takes a positive int between 0 and 125, &#x27;</span> +</span><br><span class="line">        <span class="string">&#x27;forcing frame rates higher than 125 fps is not supported&#x27;</span>,</span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (fps &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment">// 0 ~ 125 ä¹‹é—´çš„åˆ·æ–°ç‡å¯ä»¥è‡ªåŠ¨è®¡ç®—</span></span><br><span class="line">    yieldInterval = <span class="built_in">Math</span>.floor(<span class="number">1000</span> / fps);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// reset the framerate</span></span><br><span class="line">    yieldInterval = <span class="number">5</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>åˆ°æ­¤å…³äº <code>Scheduler</code> çš„è°ƒåº¦æµç¨‹éƒ½å·²ç»ç»“æŸäº†</p>
<p><img src="https://img.ninnka.top/1624796966538-performWorkUntilDeadline%20%26%20Messagechannel.png"></p>
<p><code>Scheduler</code> å®é™…æ˜¯åˆ†ä¸º <code>ä»»åŠ¡è°ƒåº¦</code> å’Œ <code>ä»»åŠ¡æ‰§è¡Œ</code> ä¸¤ä¸ªéƒ¨åˆ†çš„ï¼Œå‰é¢ç•™ä¸‹çš„â€æ¢å¤ä¸­æ–­ä»»åŠ¡â€œçš„å‘éœ€è¦åœ¨æ‰§è¡Œä¸­æ¢è®¨</p>
<h1 id="Scheduler-å¦‚ä½•æ‰§è¡Œ"><a href="#Scheduler-å¦‚ä½•æ‰§è¡Œ" class="headerlink" title="Scheduler å¦‚ä½•æ‰§è¡Œ"></a>Scheduler å¦‚ä½•æ‰§è¡Œ</h1><p><code>Scheduler</code> ä¸­è´Ÿè´£æ‰§è¡Œçš„è§’è‰²å…¶å®åœ¨å‰é¢å·²ç»æåˆ°äº†</p>
<p>åœ¨ <code>unstable_scheduleCallback</code> ä¸­æåˆ°è¿‡ <code>requestHostCallback(flushWork)</code>ï¼Œ<code>flushWork</code> æ‰æ˜¯çœŸæ­£è´Ÿè´£æ‰§è¡Œä»»åŠ¡çš„ <strong>æ‰§è¡Œè€…</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">flushWork</span>(<span class="params">hasTimeRemaining, initialTime</span>) </span>&#123;</span><br><span class="line">  isHostCallbackScheduled = <span class="literal">false</span>;</span><br><span class="line">  <span class="keyword">if</span> (isHostTimeoutScheduled) &#123;</span><br><span class="line">    <span class="comment">// è¦å¼€å§‹æ‰§è¡Œäº†ï¼Œä¸éœ€è¦å†ç­‰å¾… å¾…è°ƒåº¦ä»»åŠ¡ è¿›å…¥è°ƒåº¦é˜Ÿåˆ—äº†ï¼Œç›´æ¥å–æ¶ˆæ‰</span></span><br><span class="line">    isHostTimeoutScheduled = <span class="literal">false</span>;</span><br><span class="line">    cancelHostTimeout();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// æ ‡è®°åœ¨æ‰§è¡Œä¸­äº†</span></span><br><span class="line">  isPerformingWork = <span class="literal">true</span>;</span><br><span class="line">  <span class="comment">// ä¿å­˜å½“å‰çš„ä¼˜å…ˆçº§</span></span><br><span class="line">  <span class="keyword">const</span> previousPriorityLevel = currentPriorityLevel;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// ... è¿™é‡Œæœ‰äº›å¼€å‘ç¯å¢ƒçš„æ€§èƒ½æ”¶é›†ä»£ç ï¼Œå¿½ç•¥å³å¯</span></span><br><span class="line">    <span class="comment">// äº¤ç»™å°å¼Ÿ workLoop å»åšä»»åŠ¡ä¸­æ–­ä¸æ¢å¤äº†</span></span><br><span class="line">    <span class="keyword">return</span> workLoop(hasTimeRemaining, initialTime);</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    <span class="comment">// æ ‡è®°å½“å‰æ— ä»»åŠ¡æ‰§è¡Œ</span></span><br><span class="line">    currentTask = <span class="literal">null</span>;</span><br><span class="line">    <span class="comment">// æ¢å¤ä¼˜å…ˆçº§</span></span><br><span class="line">    currentPriorityLevel = previousPriorityLevel;</span><br><span class="line">    <span class="comment">// æ ‡è®°æ‰§è¡Œç»“æŸ</span></span><br><span class="line">    isPerformingWork = <span class="literal">false</span>;</span><br><span class="line">    <span class="comment">// ... è¿™é‡Œæœ‰äº›å¼€å‘ç¯å¢ƒçš„æ€§èƒ½æ”¶é›†ä»£ç ï¼Œå¿½ç•¥å³å¯</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åˆ†ææ€»è®¡ä¸€ä¸‹ <code>flushWork</code> åšäº†å•¥ï¼š</p>
<ul>
<li>å–æ¶ˆæ‰ <code>hostTimeout</code>ï¼Œå› ä¸ºè¦å¼€å§‹æ‰§è¡Œäº†ï¼Œä¸éœ€è¦å†ç­‰å¾… å¾…è°ƒåº¦ä»»åŠ¡ è¿›å…¥è°ƒåº¦é˜Ÿåˆ—äº†</li>
<li>æ ‡è®°åœ¨æ‰§è¡Œä¸­äº† <code>isPerformingWork = true</code></li>
<li>ä¿å­˜å½“å‰çš„ä¼˜å…ˆçº§</li>
<li>äº¤ç»™å°å¼Ÿ <code>workLoop</code> å»åšä»»åŠ¡ä¸­æ–­ä¸æ¢å¤äº†</li>
<li>æ‰§è¡Œç»“æŸåï¼Œæ ‡è®°å½“å‰æ— ä»»åŠ¡æ‰§è¡Œï¼Œæ¢å¤ä¼˜å…ˆçº§ï¼Œæ ‡è®°æ‰§è¡Œç»“æŸ <code>isPerformingWork = false</code></li>
</ul>
<p><code>flushWork</code> ä»£ç è¿˜æ˜¯æŒºç®€å•çš„ï¼Œå› ä¸ºè´Ÿè´£çš„äº‹æƒ…éƒ½äº¤ç»™å°å¼Ÿ <code>workLoop</code> å»å¹²äº†</p>
<p>æˆ‘ä»¬å¸¸è¯´çš„ä»»åŠ¡æ¢å¤ä¸ä¸­æ–­éƒ½åœ¨å°å¼Ÿ <code>workLoop</code> ä¸­æ‰§è¡Œ</p>
<h2 id="workLoop-ä»»åŠ¡ä¸­æ–­ä¸ä»»åŠ¡æ¢å¤"><a href="#workLoop-ä»»åŠ¡ä¸­æ–­ä¸ä»»åŠ¡æ¢å¤" class="headerlink" title="workLoop ä»»åŠ¡ä¸­æ–­ä¸ä»»åŠ¡æ¢å¤"></a>workLoop ä»»åŠ¡ä¸­æ–­ä¸ä»»åŠ¡æ¢å¤</h2><p>è™½è¯´åˆšåˆšæåˆ° <code>flushWork</code> æ˜¯æ‰§è¡Œè€…ï¼Œä½†æ˜¯å¾ˆå¤šè„æ´»ç´¯æ´»éƒ½æ˜¯ <code>workLoop</code> åœ¨åšï¼Œæ¯”å¦‚è€ç”Ÿå¸¸è°ˆçš„ <code>ä»»åŠ¡ä¸­æ–­ä¸ä»»åŠ¡æ¢å¤</code></p>
<div align="center">
<img width=180 style="background: #fff" src="https://img.ninnka.top/1624803015163-a7s52-ifhqj.png"/>
</div>

<p>æˆ‘ä»¬çœ‹çœ‹ <code>workLoop</code> å…·ä½“æ˜¯æ€ä¹ˆåšçš„ï¼Œä»£ç è¿˜æŒºé•¿ï¼Œä¸‹é¢ä¼šåšè¯¦ç»†è§£è¯»</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">workLoop</span>(<span class="params">hasTimeRemaining, initialTime</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> currentTime = initialTime;</span><br><span class="line">  <span class="comment">// ç†Ÿæ‚‰çš„ advanceTimersï¼Œå…ˆæŠŠè¿‡æœŸçš„ä»»åŠ¡ä» timerQueue æå‡ºæ¥ä¸¢åˆ° taskQueue æ‰“åŒ…ä¸€å—æ‰§è¡Œäº†</span></span><br><span class="line">  advanceTimers(currentTime);</span><br><span class="line">  <span class="comment">// è·å–ä¼˜å…ˆçº§æœ€é«˜çš„ä»»åŠ¡</span></span><br><span class="line">  currentTask = peek(taskQueue);</span><br><span class="line">  <span class="comment">// å¾ªç¯ä»»åŠ¡é˜Ÿåˆ—</span></span><br><span class="line">  <span class="keyword">while</span> (</span><br><span class="line">    currentTask !== <span class="literal">null</span> &amp;&amp;</span><br><span class="line">    !(enableSchedulerDebugging &amp;&amp; isSchedulerPaused)</span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">      currentTask.expirationTime &gt; currentTime &amp;&amp;</span><br><span class="line">      (!hasTimeRemaining || shouldYieldToHost())</span><br><span class="line">    ) &#123;</span><br><span class="line">      <span class="comment">// å¦‚æœæ²¡æœ‰å‰©ä½™æ—¶é—´æˆ–è€…è¯¥åœæ­¢äº†å°±é€€å‡ºå¾ªç¯</span></span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> callback = currentTask.callback;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> callback === <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">      <span class="comment">// åªæœ‰ callback ä¸ºå‡½æ•°æ—¶æ‰ä¼šè¢«è¯†åˆ«ä¸ºæœ‰æ•ˆçš„ä»»åŠ¡</span></span><br><span class="line">      currentTask.callback = <span class="literal">null</span>;</span><br><span class="line">      <span class="comment">// è®¾ç½®æ‰§è¡Œä»»åŠ¡çš„ä¼˜å…ˆçº§ï¼Œå›æƒ³ä¸‹ flushWorkä¸­çš„æ¢å¤ä¼˜å…ˆçº§ï¼Œå…³é”®å°±åœ¨è¿™</span></span><br><span class="line">      currentPriorityLevel = currentTask.priorityLevel;</span><br><span class="line">      <span class="keyword">const</span> didUserCallbackTimeout = currentTask.expirationTime &lt;= currentTime;</span><br><span class="line">      <span class="comment">// ã€‚ã€‚ã€‚</span></span><br><span class="line">      <span class="keyword">const</span> continuationCallback = callback(didUserCallbackTimeout);</span><br><span class="line">      currentTime = getCurrentTime();</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">typeof</span> continuationCallback === <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">        <span class="comment">// è¿™é‡Œæ˜¯çœŸæ­£çš„æ¢å¤ä»»åŠ¡ï¼Œç­‰å¾…ä¸‹ä¸€è½®å¾ªç¯æ—¶æ‰§è¡Œ</span></span><br><span class="line">        currentTask.callback = continuationCallback;</span><br><span class="line">        <span class="comment">// ....</span></span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// ... ä¸éœ€è¦æ¢å¤ä»»åŠ¡äº†ï¼Œæ ‡è¯†å½“å‰ä»»åŠ¡å·²æ‰§è¡Œå®Œï¼ŒæŠŠä»»åŠ¡ä»é˜Ÿåˆ—ä¸­ç§»é™¤æ‰</span></span><br><span class="line">        <span class="comment">// å› ä¸ºè¢«ä¸­æ–­çš„ä»»åŠ¡æ˜¯</span></span><br><span class="line">        <span class="keyword">if</span> (currentTask === peek(taskQueue)) &#123;</span><br><span class="line">          pop(taskQueue);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// ç†Ÿæ‚‰çš„ advanceTimersï¼Œå…ˆæŠŠè¿‡æœŸçš„ä»»åŠ¡ä» timerQueue æå‡ºæ¥ä¸¢åˆ° taskQueue æ‰“åŒ…ä¸€å—æ‰§è¡Œäº†</span></span><br><span class="line">      advanceTimers(currentTime);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// callback ä¸ºç©ºï¼Œä¸æ˜¯æœ‰æ•ˆçš„ä»»åŠ¡æˆ–è€…å·²ç»æ‰§è¡Œå®Œäº†ï¼Œç›´æ¥ç§»é™¤æ‰</span></span><br><span class="line">      pop(taskQueue);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// è·å–æœ€é«˜ä¼˜å…ˆçº§çš„ä»»åŠ¡ï¼ˆä¸ä¸€å®šæ˜¯ä¸‹ä¸€ä¸ªä»»åŠ¡ï¼‰</span></span><br><span class="line">    currentTask = peek(taskQueue);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span> (currentTask !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// è¿˜æœ‰ä»»åŠ¡è¯´æ˜è°ƒåº¦è¢«æš‚åœäº†ï¼Œè¿”å›trueæ ‡æ˜éœ€è¦æ¢å¤ä»»åŠ¡</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> firstTimer = peek(timerQueue);</span><br><span class="line">    <span class="keyword">if</span> (firstTimer !== <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="comment">// ä»»åŠ¡éƒ½è·‘å®Œäº†ï¼Œåˆåˆ°äº†ç†Ÿæ‚‰çš„ requestHostTimeout(handleTimeout, firstTimer.startTime - currentTime)</span></span><br><span class="line">      requestHostTimeout(handleTimeout, firstTimer.startTime - currentTime);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// è¿”å›falseæ„å‘³ç€å½“å‰ä»»åŠ¡éƒ½æ‰§è¡Œå®Œäº†ï¼Œä¸éœ€è¦æ¢å¤</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç›¸ä¿¡â€ä»£ç å¤ªé•¿ï¼Œä¸æƒ³çœ‹â€œçš„å„ä½å·²ç»ç›´æ¥ç¿»åˆ°è¿™é‡Œäº†</p>
<p>è€è§„çŸ©ï¼Œæ€»ç»“åˆ†æä¸€æ³¢ï¼š</p>
<ul>
<li>åœ¨å¾ªç¯ <code>taskQueue</code> ä¹‹å‰ï¼Œå…ˆé€šè¿‡ <code>advanceTimers</code> æŠŠè¿‡æœŸçš„ä»»åŠ¡ä» <code>timerQueue</code> æå‡ºæ¥ä¸¢åˆ° <code>taskQueue</code> æ‰“åŒ…ä¸€å—æ‰§è¡Œäº†</li>
<li>è·å–ä¼˜å…ˆçº§æœ€é«˜çš„ä»»åŠ¡ä½œä¸ºç¬¬ä¸€ä¸ªå¤„ç†çš„ä»»åŠ¡</li>
<li>è¿›å…¥å¾ªç¯ï¼Œåœ¨æ‰§è¡Œä»»åŠ¡å‰ï¼Œå…ˆçœ‹çœ‹è¿˜æœ‰æ²¡æœ‰æ—¶é—´</li>
<li>å¦‚æœæ²¡æœ‰æ—¶é—´ï¼Œè·³å‡ºå¾ªç¯ï¼Œè¿”å› trueï¼Œæ ‡æ˜éœ€è¦æ¢å¤ä»»åŠ¡</li>
<li>å¦‚æœæœ‰æ—¶é—´ï¼Œæ­£å¸¸æ‰§è¡Œä»»åŠ¡ï¼Œå¹¶ä¿å­˜ä»»åŠ¡çš„è¿”å›å€¼</li>
<li>å¦‚æœè¿”å›å€¼æ˜¯å‡½æ•°ï¼Œè¯´æ˜ä»»åŠ¡æ‰§è¡Œæ—¶é•¿ä¸å¤Ÿäº†ï¼Œéœ€è¦æ¢å¤</li>
<li>å¦‚æœè¿”å›å€¼ä¸æ˜¯å‡½æ•°ï¼Œè¯´æ˜å·²ç»æ‰§è¡Œå®Œäº†ï¼Œä»é˜Ÿåˆ—ä¸­ç§»é™¤å½“å‰ä»»åŠ¡</li>
<li>æ¯ä¸ªä»»åŠ¡æ‰§è¡Œåï¼ˆä¸ä¸€å®šæ‰§è¡Œå®Œï¼‰ï¼Œéƒ½é€šè¿‡ <code>advanceTimers</code> æŠŠè¿‡æœŸçš„ä»»åŠ¡ä» <code>timerQueue</code> æå‡ºæ¥ä¸¢åˆ° <code>taskQueue</code>ï¼Œå› ä¸ºåœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­æœ‰å¯èƒ½éƒ¨åˆ†ä»»åŠ¡ä¹Ÿè¿‡æœŸäº†</li>
</ul>
<p>ç»“åˆ <code>flushWork</code> å’Œ <code>workLoop</code> æ¥çœ‹ï¼Œæµç¨‹å¤§æ¦‚æ˜¯è¿™æ ·çš„</p>
<p><img src="https://img.ninnka.top/1624801928271-flushWork%20%26%20workLoop.png"></p>
<h2 id="shouldYieldToHost"><a href="#shouldYieldToHost" class="headerlink" title="shouldYieldToHost"></a>shouldYieldToHost</h2><p>æ‰§è¡Œçš„æµç¨‹åŸºæœ¬å·²ç»“æŸï¼Œä½†æœ‰ä¸€ä¸ªè¿˜éœ€è¦æä¸€å˜´çš„å‡½æ•° <code>shouldYieldToHost</code></p>
<p>è¿™ä¸ªå‡½æ•°ç”¨æ¥åˆ¤æ–­æ˜¯å¦éœ€è¦ç­‰å¾…</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> scheduling = navigator.scheduling;</span><br><span class="line">shouldYieldToHost = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> currentTime = getCurrentTime();</span><br><span class="line">  <span class="keyword">if</span> (currentTime &gt;= deadline) &#123;</span><br><span class="line">    <span class="comment">// ä»»åŠ¡æ‰§è¡Œå·²è¶…å‡ºæ—¶é—´åˆ†ç‰‡çš„å…è®¸èŒƒå›´</span></span><br><span class="line">    <span class="comment">// åˆ¤æ–­ä¸€ä¸‹æµè§ˆå™¨çš„æ¸²æŸ“è¿›ç¨‹æ˜¯å¦åœ¨å·¥ä½œä¸­ï¼Œæ˜¯å¦æœ‰ç”¨æˆ·äº¤äº’</span></span><br><span class="line">    <span class="keyword">if</span> (needsPaint || scheduling.isInputPending()) &#123;</span><br><span class="line">      <span class="comment">// å¦‚æœæœ‰ï¼Œå°±è®¤ä¸ºå½“å‰ä»»åŠ¡éœ€è¦åœæ­¢äº†</span></span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å¦‚æœæµè§ˆå™¨å¾ˆç©ºé—²ï¼Œé‚£ä¹ˆå†ç»™äº›æ—¶é—´æ‰§è¡Œä»»åŠ¡</span></span><br><span class="line">    <span class="keyword">return</span> currentTime &gt;= maxYieldInterval;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// æ—¶é—´è¿˜å……è¶³ï¼Œä¸éœ€è¦åœä¸‹</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>å‡½æ•°ä¸»è¦é€šè¿‡æ¯”è¾ƒå½“å‰æ—¶é—´å’Œä»»åŠ¡æ‰§è¡Œæˆªæ­¢æ—¶é—´ï¼Œå¦‚æœ <code>currentTime &gt;= deadline</code> é‚£ä¹ˆä»»åŠ¡è¶…å‡ºæ—¶é—´åˆ†ç‰‡çš„å…è®¸èŒƒå›´ï¼Œéœ€è¦æš‚åœ</p>
<p>æ¯”è¾ƒæƒŠå–œçš„æ˜¯ï¼Œè¿™ä¸ªå‡½æ•°ç”¨åˆ°äº†ä¸€ä¸ªæ–°çš„web apiï¼Œ<code>navigator.scheduling</code></p>
<p>è¿™ä¸ªæ–°çš„ api å°±å¾ˆæœ‰æ„æ€äº†ï¼Œå®ƒæ˜¯ facebook å¯¹æµè§ˆå™¨è´¡çŒ®çš„ç¬¬ä¸€ä¸ª api <a target="_blank" rel="noopener" href="https://engineering.fb.com/2019/04/22/developer-tools/isinputpending-api/">isinputpending-api</a></p>
<p><img src="https://img.ninnka.top/1624804223052-otmeytc2idaafvqyj9c3dcekdw4.jpg"></p>
<p>æ„Ÿå…´è¶£çš„å°ä¼™ä¼´å¯ä»¥è‡ªè¡ŒæŸ¥é˜…</p>
<h1 id="æ€»ç»“-1"><a href="#æ€»ç»“-1" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>åˆ°æ­¤ï¼Œå¯¹ <code>Scheduler</code> è§£è¯»å°±æš‚å‘Šä¸€æ®µè½äº†ï¼Œä¸»è¦æ˜¯å¯¹ä¸»æµç¨‹åˆ†æ”¯çš„ä»£ç åšäº†ä¸€æ¬¡è§£è¯»ï¼Œå…¶å®åˆ†æ”¯æµç¨‹ä¸­è¿˜æœ‰äº›ç­‰å¾…å‘ç°çš„å¥¥ç§˜ã€‚ç›®å‰åŸºäº <code>react v17.0.2</code> <code>scheduler v0.20.0</code> åˆ†æï¼Œä»¥åæºç è‹¥æœ‰æ›´æ–°ä¼šå°½æ—©åŒæ­¥</p>
<p>æ½‡æ½‡æ´’æ´’ 35300+ å­—ï¼Œå¸Œæœ›çœ‹åˆ°è¿™é‡Œçš„å°ä¼™ä¼´ç»™ä¸ªèµğŸ‘ğŸ»</p>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/React/" rel="tag"># React</a>
              <a href="/tags/JavaScript/" rel="tag"># JavaScript</a>
              <a href="/tags/Scheduler/" rel="tag"># Scheduler</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2021/06/14/%E6%BA%90%E7%A0%81%E7%BB%86%E8%AF%BB-%E6%B7%B1%E5%85%A5%E4%BA%86%E8%A7%A3terser-webpack-plugin%E7%9A%84%E5%AE%9E%E7%8E%B0/" rel="prev" title="æºç ç»†è¯»-æ·±å…¥äº†è§£terser-webpack-pluginçš„å®ç°">
      <i class="fa fa-chevron-left"></i> æºç ç»†è¯»-æ·±å…¥äº†è§£terser-webpack-pluginçš„å®ç°
    </a></div>
      <div class="post-nav-item">
    <a href="/2021/06/19/JSON-Web-Token%E8%A7%A3%E6%83%91/" rel="next" title="JSON Web Tokenè§£æƒ‘">
      JSON Web Tokenè§£æƒ‘ <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          æ–‡ç« ç›®å½•
        </li>
        <li class="sidebar-nav-overview">
          ç«™ç‚¹æ¦‚è§ˆ
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Scheduler-%E5%A4%9A%E4%BB%BB%E5%8A%A1%E6%97%B6%E9%97%B4%E7%AE%A1%E7%90%86%E5%A4%A7%E5%B8%88"><span class="nav-number">1.</span> <span class="nav-text">Scheduler å¤šä»»åŠ¡æ—¶é—´ç®¡ç†å¤§å¸ˆ</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#React-amp-Scheduler-%E7%BC%A0%E7%BC%A0%E7%BB%B5%E7%BB%B5"><span class="nav-number">2.</span> <span class="nav-text">React &amp; Scheduler ç¼ ç¼ ç»µç»µ</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#enqueueUpdate-%E5%87%BD%E6%95%B0"><span class="nav-number">2.1.</span> <span class="nav-text">enqueueUpdate å‡½æ•°</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Update-%E5%AF%B9%E8%B1%A1"><span class="nav-number">2.2.</span> <span class="nav-text">Update å¯¹è±¡</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Lane-%E5%A4%9A%E8%BD%A6%E9%81%93%E4%BC%98%E5%85%88%E7%BA%A7%E6%A8%A1%E5%9E%8B"><span class="nav-number">2.3.</span> <span class="nav-text">Lane å¤šè½¦é“ä¼˜å…ˆçº§æ¨¡å‹</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#scheduleUpdateOnFiber-%E5%87%BD%E6%95%B0"><span class="nav-number">2.4.</span> <span class="nav-text">scheduleUpdateOnFiber å‡½æ•°</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ensureRootIsScheduled-%E5%87%BD%E6%95%B0"><span class="nav-number">2.5.</span> <span class="nav-text">ensureRootIsScheduled å‡½æ•°</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#lanePriorityToSchedulerPriority"><span class="nav-number">2.5.1.</span> <span class="nav-text">lanePriorityToSchedulerPriority</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#scheduleSyncCallback-amp-scheduleCallback-%E8%B0%83%E5%BA%A6%E5%85%A5%E5%8F%A3"><span class="nav-number">2.5.2.</span> <span class="nav-text">scheduleSyncCallback &amp; scheduleCallback è°ƒåº¦å…¥å£</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#flushSyncCallbackQueueImpl"><span class="nav-number">2.5.3.</span> <span class="nav-text">flushSyncCallbackQueueImpl</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#reactPriorityToSchedulerPriority"><span class="nav-number">2.5.4.</span> <span class="nav-text">reactPriorityToSchedulerPriority</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%80%BB%E7%BB%93"><span class="nav-number">2.6.</span> <span class="nav-text">æ€»ç»“</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Scheduler-%E5%A6%82%E4%BD%95%E8%B0%83%E5%BA%A6"><span class="nav-number">3.</span> <span class="nav-text">Scheduler å¦‚ä½•è°ƒåº¦</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%86%99%E5%9C%A8%E5%89%8D%E9%9D%A2"><span class="nav-number">3.1.</span> <span class="nav-text">å†™åœ¨å‰é¢</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#unstable-scheduleCallback"><span class="nav-number">3.2.</span> <span class="nav-text">unstable_scheduleCallback</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#expirationTime-%E8%BF%87%E6%9C%9F%E6%97%B6%E9%97%B4"><span class="nav-number">3.3.</span> <span class="nav-text">expirationTime è¿‡æœŸæ—¶é—´</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#push-timerQueue-newTask-amp-push-taskQueue-newTask"><span class="nav-number">3.4.</span> <span class="nav-text">push(timerQueue, newTask) &amp; push(taskQueue, newTask)</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#timeout"><span class="nav-number">3.4.1.</span> <span class="nav-text">timeout</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#requestHostTimeout-amp-cancelHostTimeout"><span class="nav-number">3.5.</span> <span class="nav-text">requestHostTimeout &amp; cancelHostTimeout</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#handleTimeout"><span class="nav-number">3.6.</span> <span class="nav-text">handleTimeout</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#advanceTimers"><span class="nav-number">3.7.</span> <span class="nav-text">advanceTimers</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#requestHostCallback"><span class="nav-number">3.8.</span> <span class="nav-text">requestHostCallback</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#performWorkUntilDeadline"><span class="nav-number">3.9.</span> <span class="nav-text">performWorkUntilDeadline</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#MessageChannel"><span class="nav-number">3.10.</span> <span class="nav-text">MessageChannel</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#yieldInterval-amp-forceFrameRate"><span class="nav-number">3.11.</span> <span class="nav-text">yieldInterval &amp; forceFrameRate</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Scheduler-%E5%A6%82%E4%BD%95%E6%89%A7%E8%A1%8C"><span class="nav-number">4.</span> <span class="nav-text">Scheduler å¦‚ä½•æ‰§è¡Œ</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#workLoop-%E4%BB%BB%E5%8A%A1%E4%B8%AD%E6%96%AD%E4%B8%8E%E4%BB%BB%E5%8A%A1%E6%81%A2%E5%A4%8D"><span class="nav-number">4.1.</span> <span class="nav-text">workLoop ä»»åŠ¡ä¸­æ–­ä¸ä»»åŠ¡æ¢å¤</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#shouldYieldToHost"><span class="nav-number">4.2.</span> <span class="nav-text">shouldYieldToHost</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%80%BB%E7%BB%93-1"><span class="nav-number">5.</span> <span class="nav-text">æ€»ç»“</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Ninnka</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">27</span>
          <span class="site-state-item-name">æ—¥å¿—</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">27</span>
        <span class="site-state-item-name">åˆ†ç±»</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">63</span>
        <span class="site-state-item-name">æ ‡ç­¾</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Ninnka</span>
</div>
  <div class="powered-by">ç”± <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> å¼ºåŠ›é©±åŠ¨
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
